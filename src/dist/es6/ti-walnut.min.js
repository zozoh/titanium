const Io=function(){function t(t){return"/o/"+t}function e(t,e){if(!t.ok){if(_.isUndefined(e))throw t;return e}return t.data}const i={OID(t){if(!t)return{};let e=_.trim(t),i=e.indexOf(":");return i<0?{id:e,myId:e}:{id:e,homeId:e.substring(0,i).trim(),myId:e.substring(i+1).trim()}},getObjMyId:t=>i.OID(t).myId,isFullObjId:t=>/^[0-9a-v]{26}(:.+)?$/.test(t),isFullObjIdPath:t=>/^id:[0-9a-v]{26}(:.+)?$/.test(t),async loadMetaBy(t,e,n){if(i.isFullObjId(t))return await i.loadMetaById(t,n);if(/^(id:|\/|~)/.test(t))return await i.loadMeta(t,n);let a;a=e?_.isString(e)?Ti.Util.getParentPath(e):"FILE"==e.race?"id:"+e.pid:"id:"+e.id:"~";let o=Ti.Util.appendPath(a,t);return await i.loadMeta(o)},loadMetaById:async(t,e)=>await i.loadMeta("id:"+t,e),async loadMeta(i,{loadPath:n=!1}={}){let a=t(n?"fetch2":"fetch");return e(await Ti.Http.get(a,{params:{str:i},as:"json"}),null)},async loadMetaAt(t,e){let n=e;return t&&!/^(~\/|\/|id:)/.test(e)&&(n=`id:${t.pid}/${e}`),await i.loadMeta(n)},async loadAncestors(i){let n=t("ancestors");return e(await Ti.Http.get(n,{params:{str:i},as:"json"}),[])},async loadChildren(n,{skip:a,limit:o,sort:s={nm:1},mine:r,match:l={}}={}){if(!n)return null;if("DIR"!=n.race)return 0===o?[]:{};if(n.mnt||n.ln){let i=t("children");return e(await Ti.Http.get(i,{params:{str:`id:${n.id}`,pg:!0},as:"json"}))}l.pid=n.id;let c=await i.find({skip:a,limit:o,sort:s,mine:r,match:l});if(n.ph&&c&&_.isArray(c.list))for(let t of c.list)t.ph||(t.ph=Ti.Util.appendPath(n.ph,t.nm));return c},async find({skip:i=0,limit:n=100,sort:a={},mine:o=!0,match:s={}}={}){let r=t("find");return e(await Ti.Http.get(r,{params:_.assign({},s,{_l:n,_o:i,_me:o,_s:JSON.stringify(a)}),as:"json"}))},async findList(t={}){let e=await i.find(t);return e&&_.isArray(e.list)?e.list:[]},async findInBy(t,e,{skip:n=0,limit:a=100,sort:o={},mine:s=!0,match:r={},keys:l={"^[0-9a-v]{26}(:.+)$":["id","${val}"]},dftKey:c=["nm","^.*${val}.*$"]}={}){if(!_.isUndefined(t)){let e=c;for(let i of _.keys(l))if(new RegExp(i).test(t)){e=l[i];break}let i=e[0],n=Ti.S.renderBy(e[1],{val:t});r[i]=n}if(e&&e.id&&e.ph)r.pid=e.id;else if(_.isString(e)){let t=await i.loadMeta(e);r.pid=t.id}return await i.find({skip:n,limit:a,sort:o,mine:s,match:r})},async findListInBy(t,e,n={}){let a=await i.findInBy(t,e,n);return a&&_.isArray(a.list)?a.list:[]},async loadContent(e,{as:n="text"}={}){if(_.isString(e)&&(e=await i.loadMeta(e)),!e||"DIR"==e.race)return null;let a=e.mime||"application/octet-stream";if(Wn.Util.isMimeText(a)){let i=t("content");return await Ti.Http.get(i,{params:{str:"id:"+e.id,d:"raw"},as:n})}return e.sha1},async update(e,n={}){if(!e||_.isEmpty(n))return;if(_.isString(e)&&(e=await i.loadMetaBy(e)),!_.isPlainObject(e))throw Ti.Err.make("e-wn-io-invalidUpdateTarget",e);let a=t("/update"),o=await Ti.Http.post(a,{params:{str:"id:"+e.id},body:JSON.stringify(n),as:"json"});if(!o.ok)throw Ti.Err.make(o.errCode,o.data,o.msg);return o.data},async saveContentAsText(e,i,{createIfNoExists:n=!1,asBase64:a=!1}={}){if(!e)return;Ti.Util.isNil(i)&&(i="");let o;if(e.id&&e.ph){let{id:t,nm:i,ph:n,race:a}=e;if("DIR"==a)throw Ti.Err.make("e-wn-io-writeNoFile",n||i);o=`id:${t}`}else o=e;let s={str:o,content:i,cine:n,base64:a},r=t("/save/text"),l=await Ti.Http.post(r,{params:s,as:"json"});if(!l.ok)throw Ti.Err.make(l.errCode,l.data,l.msg);return l.data},async uploadFile(e,{target:i="~",mode:n="a",tmpl:a="${major}(${nb})${suffix}",progress:o=_.identity}={}){let s=t("/save/stream");return await Ti.Http.post(s,{file:e,progress:o,params:{str:i,nm:e.uploadName||e.name,sz:e.size,mime:e.type,m:n,tmpl:a},as:"json"})},async moveTo(t,{base:e,homePath:i,objMatch:n,objFilter:a,objSort:o,treeDisplay:s,confirm:r=!1,title:l="i18n:move-to",exposeHidden:c=!1,testBeforeMove:m=((t,e)=>!!(t&&t.id&&t.nm)&&((!t.__is||!t.__is.loading&&!t.__is.removed)&&!e[t.id])),markItemStatus:d=_.identity,doneMove:p=_.identity,successTip:u="i18n:wn-move-to-ok"}={}){if(!e)return;_.isString(e)&&(e=await Wn.Io.loadMeta(e));let h=[];if(t&&(h=_.isArray(t)?t:[t]),_.isEmpty(h))return await Ti.Toast.Open("i18n:wn-move-to-none","warn");if(r&&!await Ti.Confirm({text:"i18n:wn-move-to-confirm",vars:{N:h.length}},{type:"warn"}))return;let y=await Wn.OpenObjTree(e,{title:l,homePath:i,objMatch:n,objFilter:a,objSort:o,treeDisplay:s,exposeHidden:c});if(!y||!y.id||y.id==e.id)return;let g=0,f={};try{for(let t of h){if(!m(t,f))continue;d(t.id,"loading"),await Wn.Sys.exec(`mv id:${t.id} id:${y.id}`),d(t.id,"moved");let e=/^id:(.+)$/.exec(t.videoc_dir);if(e){let t=e[1];f[t]=!0,this.setItemStatus(t,"moved"),d(t,"moved")}g++}await p()}finally{Ti.Toast.Open(u,{N:g},"success")}},getFormedPath(t){let e=t.ph?t.ph:t,i=Wn.Session.getHomePath(),n=Ti.Util.getRelativePath(i,e,"");return Ti.Util.appendPath("~",n)},formatObjPath(t,e,n){let a={path:()=>n?Ti.Util.getRelativePath(n.ph,t.ph):i.getFormedPath(t.ph),fullPath:()=>t.ph,idPath:()=>`id:${t.id}`,id:()=>t.id,nm:()=>t.nm,obj(){let e=n||["id","nm","thumb","title","mime","tp","sha1","len"];return _.pick(t,e)},wnobj:()=>t}[e];if(!a)throw"Invalid mode : "+e;return a()},async loadObjAs(t,e){let n={path:()=>i.loadMeta(t),fullPath:()=>i.loadMeta(t),idPath:()=>i.loadMeta(t),id:()=>i.loadMetaById(t),obj:()=>i.loadMetaById(t.id),wnobj:()=>_.cloneDeep(t)}[e];if(!n)throw"Invalid mode : "+e;return await n()}};return i}(),Obj=function(){const t={title:()=>({title:"i18n:wn-key-title",display:[Wn.Obj.getObjThumbDisplay("rawData"),"title|nm"]}),tp:{title:"i18n:wn-key-tp",width:-80,display:"rawData.tp::as-tip"},c:{title:"i18n:wn-key-c",width:-150,display:"rawData.c::as-tip"},m:{title:"i18n:wn-key-",width:-150,display:"rawData.c::as-tip"},g:{title:"i18n:wn-key-g",width:-150,display:"rawData.g::as-tip"},md:{title:"i18n:wn-key-md",width:120,display:{key:"rawData.md",transformer:"Wn.Obj.modeToStr",comConf:{className:"as-tip"}}},len:{title:"i18n:wn-key-len",width:-100,display:{key:"rawData.len",transformer:"Ti.S.sizeText",comConf:{className:"as-tip-block align-right"}}},ct:{title:"i18n:wn-key-ct",width:-120,display:{key:"rawData.ct",transformer:"Ti.DateTime.timeText",comConf:{className:"as-tip-block align-right is-nowrap"}}},lm:{title:"i18n:wn-key-lm",width:-120,display:{key:"rawData.lm",transformer:"Ti.DateTime.timeText",comConf:{className:"as-tip-block align-right is-nowrap"}}}},e={id:{title:"i18n:wn-key-id",name:"id",comType:"WnObjId"},nm:{title:"i18n:wn-key-nm",name:"nm",display:"<=ti-label>",comType:"ti-input"},title:{title:"i18n:wn-key-title",name:"title",emptyAs:null,display:"<=ti-label>",comType:"ti-input"},sort:{title:"i18n:sort",name:"sort",tip:"i18n:sort-tip-asc",type:"Integer",comType:"ti-input-num",comConf:{width:140}},icon:{title:"i18n:wn-key-icon",name:"icon",width:"auto",comType:"ti-input-icon"},ph:{title:"i18n:wn-key-ph",name:"ph",comConf:{className:"is-break-word"}},thumb:{title:"i18n:wn-key-thumb",name:"thumb",checkEquals:!1,comType:"wn-upload-file",comConf:{valueType:"idPath",exlink:!1,target:"~/.thumbnail/gen/${id}.jpg",filter:"cover(256,256)",quality:.372}},race:{title:"i18n:wn-key-race",name:"race",comConf:{format:"i18n:wn-race-${race}"}},mime:{title:"i18n:wn-key-mime",name:"mime"},tp:{title:"i18n:wn-key-tp",name:"tp"},ct:{title:"i18n:wn-key-ct",name:"ct",type:"AMS"},lm:{title:"i18n:wn-key-lm",name:"lm",type:"AMS"},expi:{title:"i18n:wn-key-expi",name:"expi",type:"AMS"},pid:{title:"i18n:wn-key-pid",name:"pid"},d0:{title:"i18n:wn-key-d0",name:"d0"},d1:{title:"i18n:wn-key-d1",name:"d1"},c:{title:"i18n:wn-key-c",name:"c"},m:{title:"i18n:wn-key-m",name:"m"},g:{title:"i18n:wn-key-g",name:"g"},data:{title:"i18n:wn-key-data",name:"data"},sha1:{title:"i18n:wn-key-sha1",name:"sha1",comConf:{className:"is-nowrap",fullField:!1}},md:{title:"i18n:wn-key-md",name:"md",type:"Integer",comType:"WnObjMode",comConf:{valueType:"decimal"}},pvg:{title:"i18n:wn-key-pvg",name:"pvg",type:"Object",comType:"TiInputText",comConf:{autoJsValue:!0,height:200}},width:{title:"i18n:wn-key-width",name:"width"},height:{title:"i18n:wn-key-height",name:"height"},duration:{title:"i18n:wn-key-duration",name:"duration",width:"auto",comConf:{suffixText:"i18n:tu-sec"}},len:{title:"i18n:wn-key-len",name:"len",width:"auto",transformer:t=>Ti.S.sizeText(t,{bytes:!0})}},i={isValidName:t=>!t||t.search(/[%;:"'*?`\t^<>\/\\]/)>=0?(Ti.Alert("i18n:wn-rename-invalid",{type:"warn"}),!1):!(t.length>256)||(Ti.Alert("i18n:wn-rename-too-long",{type:"warn"}),!1),octalModeToStr(t){let e=parseInt(t,8);return i.modeToStr(e)},modeToStr(t){let e=[];for(let i=2;i>=0;i--){let n=t>>3*i&7;e.push((4&n)>0?"r":"-"),e.push((2&n)>0?"w":"-"),e.push((1&n)>0?"x":"-")}return e.join("")},modeToOctal:t=>t.toString(8),octalModeFromStr:t=>i.modeFromStr(t).toString(8),modeFromOctalMode:t=>parseInt(t,8),modeFromStr(t){let e=0;for(let n=0;n<3;n++){let a=3*(2-n),o=t.substring(a,a+3);e|=i.modeFromStr0(o)<<3*n}return e},modeFromStr0(t){let e=0;return"r"==t[0]&&(e|=4),"w"==t[1]&&(e|=2),"x"==t[2]&&(e|=1),e},modeToObj(t){let e=["other","member","owner"],n={mode:t,text:i.modeToStr(t),octal:t.toString(8)};for(let i=2;i>=0;i--){let a=t>>3*i&7;n[e[i]]={readable:(4&a)>0,writable:(2&a)>0,excutable:(1&a)>0}}return n},modeFromObj:({owner:t,member:e,other:n}={})=>i.mode0FromObj(t)<<6|i.mode0FromObj(e)<<3|i.mode0FromObj(n),mode0FromObj({readable:t,writable:e,excutable:i}={}){let n=0;return t&&(n|=4),e&&(n|=2),i&&(n|=1),n},parseMode(t,e=!1){let n=0;return/^\{.+\}$/.test(t)&&(t=JSON.parse(t)),_.isPlainObject(t)?t.readable?i.mode0FromObj(t):i.modeFromObj(t):(n=/^[rwx-]{3,9}$/.test(t)?3==t.length?i.modeFromStr0(t):i.modeFromStr(t):/^0[0-7]{3}$/.test(t)?i.modeFromOctalMode(t.substring(1)):e?i.modeFromOctalMode(t):parseInt(t),i.modeToObj(n))},isBuiltInFields:t=>!!e[t],getGroupTitle:t=>/^(basic|privilege|thumb|timestamp|more|advance|customized|others)$/.test(t)?`i18n:wn-key-grp-${t}`:t,getObjThumbDisplay:(t="..",{dftIcon:e="fas-birthday-cake",className:i}={})=>({key:t,type:"Object",transformer:{name:"Ti.Types.toObject",args:{icon:"icon",thumb:"thumb",type:"tp",mime:"mime",race:"race",timestamp:"__updated_time"}},comType:"wn-obj-icon",comConf:{className:i,"...":"${=value}",defaultIcon:e}}),getTableFieldAs(t,e,i=_.identity){_.isFunction(e)&&(i=e,e=null);let n={title:t};return n.display="size"==e?{key:`rawData.${t}`,transformer:"Ti.S.sizeText",comConf:{className:"as-tip-block align-right"}}:"AMS"==e?{key:`rawData.${t}`,transformer:"Ti.DateTime.timeText",comConf:{className:"as-tip-block align-right is-nowrap"}}:{key:`rawData.${t}`},i(n)||n},getTableField(e){if(_.isString(e)){let i=_.get(t,e);return i?_.isFunction(i)?i(e):i:{title:e,display:e}}return _.isFunction(e)?e():e},getField(t){let i=e[t];return i?_.cloneDeep(i):{title:t,name:t,type:"String"}},evalFields(t={},e=[],i=_.identity){const n=function(e=[],i=[],a={}){return _.forEach(e,e=>{if("..."==e)return void i.push(e);let o,s=!1;if(_.isString(e))s=!0,o=Wn.Obj.getField(e);else if(_.isArray(e.fields)){if(o={title:Wn.Obj.getGroupTitle(e.title),type:"Group",fields:[]},n(e.fields,o.fields,a),_.isEmpty(o.fields))return}else o=e;let r=Ti.S.join([o.name],"-");a[r]=!0;let l=_.get(t,o.name);i.push(_.assign(o,{quickName:s,uniqKey:r,value:l}))}),i},a=function(e=[],n=[],o={}){for(let s of e)if("Group"!=s.type)if("..."==s)_.forEach(t,(t,e)=>{if(Ti.Util.isNil(t)||Wn.Obj.isBuiltInFields(e)||o[e]||"children"==e||e.startsWith("_"))return;let a={Integer:{type:"Number",display:e,comType:"ti-input"},Number:{type:"Number",display:e,comType:"ti-input"},Boolean:{type:"Boolean",comType:"ti-toggle"},Array:{type:"Array",display:{key:e},transformer:"JSON.stringify(null, '  ')",comType:"ti-input-text",comConf:{height:240}}}[Ti.Types.getJsType(t,"String")]||{type:"String",display:{key:e,comConf:{width:"100%",className:_.isString(t)&&t.length>20?"is-break-word":"is-nowrap"}},comType:"ti-input"},s=i({title:e,name:e,...a});s&&n.push(s)});else{let t=i(s);t&&n.push(t)}else s.fields=a(s.fields,[],o),_.isEmpty(s.fields)||n.push(s);return n};let o={},s=n(e,[],o);return s=a(s,[],o)},isAs(t={},e,n){let a=_.get(t,e);if(Ti.Util.isNil(a))return!1;if(_.isArray(n)){for(let a of n)if(i.isAs(t,e,a))return!0;return!1}return _.isString(n)?n.startsWith("^")?new RegExp(n).test(a):n.startsWith("!^")?!new RegExp(n.substring(1)).test(a):a==n:!!_.isRegExp(n)&&n.test(a)},isMime:(t={},e)=>i.isAs(t,"mime",e),isType:(t={},e)=>i.isAs(t,"type",e),evalCrumbData({meta:t,ancestors:e=[],fromIndex:i=0,homePath:n=null,titleBy:a,iteratee:o=_.identity,self:s=_.identity}={}){let r=[];if(t){let l=_.map(e),c=i;if(n)for(n.endsWith("/")&&(n=n.substring(0,n.length-1));c<l.length;c++){if(l[c].ph==n)break}for(;c<l.length;c++){let t=l[c],e={icon:Wn.Util.getIconObj(t),text:Wn.Util.getObjDisplayName(t,a),value:t.id,href:Wn.Util.getAppLink(t)+""};(e=o(e,c,t))&&r.push(e)}if(s){let e={icon:Wn.Util.getIconObj(t),text:Wn.Util.getObjDisplayName(t,a),value:t.id,href:null,asterisk:_.get(this.mainStatus,"changed")};_.isFunction(s)&&(e=s(e,c,t)||e),e&&r.push(e)}}return r}};return i}(),Session=function(){const t={},e={},i={setup({id:t,uid:n,unm:a,me:o,grp:s,by_tp:r,by_val:l,envs:c={}}={}){_.assign(e,{id:t,uid:n,unm:a,me:o,grp:s,by_tp:r,by_val:l}),i.env(c)},env(e){if(_.isPlainObject(e))_.assign(t,e);else{if(_.isString(e))return t[e];if(_.isArray(e))return _.pick(t,e)}return _.cloneDeep(t)},getLang:()=>i.env("LANG"),getMyId:()=>e.uid,getMyName:()=>e.unm,getMyGroup:()=>e.grp,getByType:()=>e.by_tp,isByType:t=>_.isRegExp(t)?t.test(e.by_tp):_.isString(t)&&t.startsWith("^")?new RegExp(t).test(e.by_tp):t==e.by_tp,getByValue:()=>e.by_val,isByValue:t=>_.isRegExp(t)?t.test(e.by_val):_.isString(t)&&t.startsWith("^")?new RegExp(t).test(e.by_val):t==e.by_val,getMe:()=>e.me,I_am_domain_ADMIN:()=>"ADMIN"==_.get(e.me,"roleInDomain"),I_am_domain_MEMBER(){let t=_.get(e.me,"roleInDomain");return/^(ADMIN|MEMEBER)$/.test(t)},I_am_op_ADMIN:()=>"ADMIN"==_.get(e.me,"roleInOp"),I_am_op_MEMBER(){let t=_.get(e.me,"roleInOp");return/^(ADMIN|MEMEBER)$/.test(t)},getHomePath:()=>i.env("HOME"),getCurrentPath:(t="~")=>i.env("PWD")||t,getCurrentDomain(){let t=i.getHomePath();if(!t)return;if("/root"==t)return"root";let e=/^\/home\/(.+)$/.exec(t);return e?e[1]:void 0},getApiPrefix:()=>`/api/${i.getCurrentDomain()}`,getApiUrl(t){let e=i.getApiPrefix();return Ti.Util.appendPath(e,t)}};return i}(),Sys=function(){const WnSysRespParsing=function(){class t{constructor({macroObjSep:t,eachLine:e=_.identity,macro:i={}}={}){this.macroObjSep=t,this.lastIndex=0,this.lines=[],this.MACRO={},this.__TO=null,this.eachLine=e,this.macro=i}init(t){this.content=t}done(){this.updated({isLastCalled:!0}),_.forOwn(this.MACRO,(t,e)=>{let i=t.join("\n"),n=JSON.parse(i);this.MACRO[e]=n,Ti.InvokeBy(this.macro,e,[n])})}__push_line(t){if(t.startsWith(this.macroObjSep)){let e=t.substring(this.macroObjSep.length).trim(),[i,n]=_.without(e.split(/ *: */g),""),a=this[i];a&&(a[n]=[]),this.__TO={key:i,name:n}}else if(this.__TO){let{key:e,name:i}=this.__TO;this[e][i].push(t)}else this.lines.push(t),this.eachLine(t)}updated({isLastCalled:t=!1}={}){let e=this.content();for(;this.lastIndex<e.length;){let i=e.indexOf("\n",this.lastIndex);if(i>=this.lastIndex){let t=i+1;i>0&&"\r"==e[i-1]&&i--;let n=e.substring(this.lastIndex,i);this.__push_line(n),this.lastIndex=t}else{if(!t)break;{let t=e.substring(this.lastIndex);this.__push_line(t),this.lastIndex=e.length}}}}getResult(){return{lines:this.lines,macro:this.MACRO}}}return t}(),DFT_MACRO_OBJ_SEP="%%wn.meta."+Ti.Random.str(10)+"%%",WnSys={async exec(cmdText,{vars:vars,input:input="",appName:appName=Ti.GetAppName(),eachLine:eachLine,as:as="text",blankAs:blankAs="",macroObjSep:macroObjSep=DFT_MACRO_OBJ_SEP,autoRunMacro:autoRunMacro=!0,forceFlushBuffer:forceFlushBuffer=!1,errorBy:errorBy,PWD:PWD=Wn.Session.getCurrentPath()}={}){vars&&(cmdText=Ti.S.renderBy(cmdText,vars));let url=`/a/run/${appName}`,params={mos:macroObjSep,PWD:PWD,cmd:cmdText,in:input,ffb:forceFlushBuffer},ing={eachLine:eachLine,macroObjSep:macroObjSep};autoRunMacro&&(ing.macro={update_envs:t=>{Wn.Session.env(t),Wn.doHook("update_envs",t)}});let parsing=new WnSysRespParsing(ing),readyStateChanged=void 0;forceFlushBuffer&&_.isFunction(eachLine)&&(readyStateChanged=(()=>{parsing.updated()})),await Ti.Http.send(url,{method:"POST",params:params,as:"text",created:t=>{parsing.init(()=>t.responseText)},readyStateChanged:readyStateChanged}).catch(t=>{parsing.isError=!0}).finally(()=>{parsing.done()});let re=parsing.getResult();if(Ti.IsInfo("Wn.Sys")&&console.log("Wn.Sys.exec@return",re),parsing.isError){let t=re.lines.join("\n");if(_.isFunction(errorBy)){let[e,...i]=t.split(/ *: */),n=i.join(" : ");e=_.trim(e);let a=e.replace(/[.]/g,"-");return errorBy({code:e,msgKey:a,data:n})}throw t}return{raw:()=>re,lines:()=>re.lines,macro:()=>re.macro,text:()=>re.lines.join("\n"),json:()=>{let t=re.lines.join("\n");Ti.S.isBlank(t)&&(t=blankAs);try{return JSON.parse(t)}catch(e){throw console.error(`Error [${cmdText}] for parse JSON:`,t),e}},jso:()=>{let json=re.lines.join("\n");Ti.S.isBlank(json)&&(json=blankAs);try{return eval("("+json+")")}catch(t){throw console.error(`Error [${cmdText}] for eval JSO:`,json),t}}}[as]()},exec2:async(t,e={})=>(_.defaults(e,{errorBy:async function({code:t,msgKey:i,data:n}){let a=Ti.I18n.get(i);return Ti.Util.isNil(n)||_.isString(n)&&!n||(a+=" : "+Ti.Types.toStr(n)),await Ti.Alert(a,{title:"i18n:warn",type:"error"}),_.isFunction(e.errorAs)?e.errorAs({code:t,msgKey:i,data:n}):Ti.Err.make(t,n)}}),await Wn.Sys.exec(t,e)),execJson:async(t,e={as:"json"})=>await WnSys.exec(t,e),exec2Json:async(t,e={as:"json"})=>await WnSys.exec2(t,e)};return WnSys}(),Util=function(){const t={toFuzzyStr:(t,e=!1)=>!t||t.startsWith("^")?t:e?"^"+t:"^.*"+t,fromFuzzyStr(t){let e=/^(\^(\.\*)?)(.+)((\.\*)?\$)?$/.exec(t);return e?e[3]:t},isMimeText:t=>/^text\//.test(t)||"application/x-javascript"==t||"application/json"==t,isMimeJson:t=>"text/json"==t||"application/json"==t,getIconName(t){let e=/^<i +class=["'] *(fa|zmdi|im) +(fa|zmdi|im)-([^" ]+) *["']> *<\/i>$/.exec(t);return e?e[3]:t},genPreviewObj(e){if(e.thumb)return/https?:\/\//.test(e.thumb)?{type:"image",value:e.thumb}:{type:"image",value:"/o/thumbnail/id:"+e.id};if(e.icon){let i=t.getIconName(e.icon);return Ti.Icons.get(i,{type:"font",value:i})}return Ti.Icons.get(e)},getIconObj:t=>t&&t.icon?t.icon:Ti.Icons.get(t),getObjIcon:(t,e)=>t?t.icon||Ti.Icons.get(t,e):e,getObjThumbIcon({icon:t,thumb:e,mime:i,type:n,race:a,candidateIcon:o,timestamp:s=0}={},r){if(e){let t=`/o/content?str=${e}`;return s>0&&(t+=`&_t=${s}`),{type:"image",value:t}}return t?{type:"font",value:t}:o||(n||i||a?Ti.Icons.get({type:n,mime:i,race:a}):r)},getObjThumbIcon2(t,e){if(t.thumb){let e;return e=/^https?:\/\//.test(t.thumb)?t.thumb:`/o/content?str=${t.thumb}`,{type:"image",value:e}}return t.icon?t.icon:e||Ti.Icons.get(t)},getObjDisplayName:(t,e=[])=>Ti.Util.getFallbackEmpty(t,e,"title","nm"),getAppLink:(e,{appName:i="wn.manager",encoded:n=!1}={})=>t.getLink(`/a/open/${i}`,e,{pathKey:"id",encoded:n}),getAppLinkStr:(e,i)=>t.getAppLink(e,i).toString(),getObjBadges(t={},e){if(_.isFunction(e))return e(t);let{NW:i=null,NE:n=["ln","zmdi-open-in-new"],SW:a=null,SE:o=null}=e||{},s={},r=function(e,i){if(_.isFunction(i)&&(i=i(t)),i)if(_.isArray(i))1==i.length?s[e]=i[0]:i.length>1&&t[i[0]]&&(s[e]=i[1]);else if(_.isPlainObject(i)&&i.value){if(i.test&&!Ti.AutoMatch.test(i.test,t))return;let n=Ti.Util.explainObj(t,{type:i.type||"icon",className:i.className,style:i.style,value:i.value});n&&(s[e]=n)}else s[e]=i};return r("NW",i),r("NE",n),r("SW",a),r("SE",o),s},getObjThumbInfo(e={},{exposeHidden:i=!1,status:n={},progress:a={},badges:o,titleKey:s}={}){if(!e||!e.nm)return;let r="show";e.nm.startsWith(".")&&i&&(r=i?"weak":"hide");let l=s;return _.isFunction(s)&&(l=s()),{id:e.id,nm:e.nm,title:t.getObjDisplayName(e,l),preview:t.genPreviewObj(e),href:t.getAppLinkStr(e),visibility:r,status:n[e.id],progress:a[e.id],badges:t.getObjBadges(e,o),rawData:e}},getDownloadLink:(e,{mode:i="force",timestamp:n}={})=>t.getLink("/o/content",e,{pathKey:"str",encoded:!0,params:{d:i,_ts:n}}),getMatchByFilter({keyword:t,match:e,majorKey:i,majorValue:n}={},a={}){let o={};if(i=a.majorKey||i,t)if(/"^[\d\w]{26}(:.+)?$"/.test(t))o.id=t;else{let e=a.defaultKey||"nm",i=_.cloneDeep(a.keyword),n=_.keys(i);for(let a of n){let n=i[a];if(new RegExp(n).test(t)){e=a;break}}e.startsWith("=")?o[e.substring(1).trim()]=t:e.startsWith("~")?o[e.substring(1).trim()]="^"+t:o[e]="^.*"+t}_.isEmpty(e)||_.forEach(e,(t,e)=>{Ti.Util.isNil(t)||(o[e]=t)}),i&&!Ti.Util.isNil(n)&&_.set(o,i,n);let s=a.match;return _.isEmpty(s)||_.assign(o,s),o},getLink(t,e,{pathKey:i="ph",encoded:n=!1,params:a={}}={}){if(_.isEmpty(e))return{url:t,params:a};let o={...a};const s=t=>n?encodeURIComponent(t):t;return/^(\/|~|id:)/.test(e)?o[i]=s(e):_.isString(e)?o[i]="id"==i?e:`id:${e}`:e.id?o[i]="id"==i?e.id:`id:${e.id}`:e.ph&&(o[i]=s(e.ph)),Ti.Util.Link({url:t,params:o})},wrapTreeNode(t){if(_.isPlainObject(t)){let e={id:t.id,name:t.nm,leaf:"DIR"!=t.race,rawData:t};if(e.leaf||(e.children=[]),e.id&&e.name)return e}},genQuery:(t,{vkey:e="val",wrapArray:i=!1,errorAs:n,blankAs:a="[]"}={})=>_.isFunction(t)?t:_.isArray(t)?i?()=>t:t:_.isString(t)?e?async i=>{let o=Ti.S.renderBy(t,{[e]:i});return await Wn.Sys.exec2(o,{as:"json",input:i,errorAs:n,blankAs:a})}:async e=>await Wn.Sys.exec2(t,{as:"json",errorAs:n,blankAs:a}):void 0};return t}(),Dict={evalOptionsDict({options:t,dictVars:e,findBy:i,itemBy:n,childrenBy:a,valueBy:o,textBy:s,iconBy:r,dictShadowed:l=!0},c){let m=Ti.DictFactory.DictReferName(t);if(m){let{name:t,dynamic:i,dictKey:n}=Ti.DictFactory.explainDictName(m);if(i){let i=_.get(e,n);return i?Ti.DictFactory.CheckDynamicDict({name:t,key:i,vars:e}):null}return Ti.DictFactory.CheckDict(m,c)}return Ti.DictFactory.CreateDict({dataChildrenKey:t.dataChildrenKey,data:Wn.Util.genQuery(t,{vkey:null,blankAs:"[]"}),query:Wn.Util.genQuery(i,{blankAs:"[]"}),item:Wn.Util.genQuery(n,{errorAs:null,blankAs:"{}"}),children:Wn.Util.genQuery(a,{errorAs:null,blankAs:"[]"}),getValue:Ti.Util.genGetter(o||"id|value"),getText:Ti.Util.genGetter(s||"title|text|nm"),getIcon:Ti.Util.genGetter(r||Wn.Util.getObjThumbIcon)},{shadowed:l,hooks:c})},setup(t){_.forEach(t,(t,e)=>{if(t.dynamic){let i=_.pick(t,"dataChildrenKey","data","query","item","children","value","text","icon","shadowed");Ti.DictFactory.CreateDynamicDict(function(t={}){let e=Ti.Util.explainObj(t,i);return Ti.DictFactory.CreateDict({dataChildrenKey:e.dataChildrenKey,data:Wn.Util.genQuery(e.data,{vkey:null}),query:Wn.Util.genQuery(e.query),item:Wn.Util.genQuery(e.item,{blankAs:"{}"}),children:Wn.Util.genQuery(e.children),getValue:Ti.Util.genGetter(e.value),getText:Ti.Util.genGetter(e.text),getIcon:Ti.Util.genGetter(e.icon),shadowed:Ti.Util.fallback(e.shadowed,!0)})},e)}else{Ti.DictFactory.GetDict(e)||Ti.DictFactory.CreateDict({dataChildrenKey:t.dataChildrenKey,data:Wn.Util.genQuery(t.data,{vkey:null}),query:Wn.Util.genQuery(t.query),item:Wn.Util.genQuery(t.item,{blankAs:"{}"}),children:Wn.Util.genQuery(t.children),getValue:Ti.Util.genGetter(t.value),getText:Ti.Util.genGetter(t.text),getIcon:Ti.Util.genGetter(t.icon),shadowed:Ti.Util.fallback(t.shadowed,!0)},{name:e})}})},hMakerComponents:()=>Ti.DictFactory.GetOrCreate({data:Wn.Util.genQuery("ti coms -cqn",{vkey:null}),getValue:t=>t.name,getText:t=>t.title||t.name,getIcon:t=>t.icon||"im-plugin",isMatched:(t,e)=>{if(t.name==e||t.title==e)return!0;if(t.name&&t.name.indexOf(e)>=0)return!0;if(t.title){if(t.title.indexOf(e)>=0)return!0;let i=Ti.I18n.text(t.title);if(i&&i.indexOf(e)>=0)return!0}return!1},shadowed:!0},{name:"hMakerComponents"})},Hm=function(){const t={background:{title:"i18n:hmk-css-background",name:"background",comType:"ti-input"},"background-image":{title:"i18n:hmk-css-background-image",name:"background-image",fieldWidth:"100%",comType:"ti-input"},"background-position":{title:"i18n:hmk-css-background-position",name:"background-position",comType:"TiDroplist",comConf:{options:"#CssBackgroundPositions"}},"background-position-x":{title:"i18n:hmk-css-background-position-x",name:"background-position-x",comType:"TiSwitcher",comConf:{options:"#CssBackgroundXPositions"}},"background-position-y":{title:"i18n:hmk-css-background-position-y",name:"background-position-y",comType:"TiSwitcher",comConf:{options:"#CssBackgroundYPositions"}},"background-repeat":{title:"i18n:hmk-css-background-repeat",name:"background-repeat",comType:"TiDroplist",comConf:{options:"#CssBackgroundRepeats"}},"background-size":{title:"i18n:hmk-css-background-size",name:"background-size",width:"full",comType:"TiSwitcher",comConf:{options:"#CssBackgroundSizes"}},"background-color":{title:"i18n:hmk-css-background-color",name:"background-color",comType:"ti-input-color"},border:{title:"i18n:hmk-css-border",name:"border",comType:"ti-input"},"border-radius":{title:"i18n:hmk-css-border-radius",name:"border-radius",comType:"ti-input"},"box-shadow":{title:"i18n:hmk-css-box-shadow",name:"box-shadow",comType:"ti-input"},color:{title:"i18n:hmk-css-color",name:"color",comType:"ti-input-color"},float:{title:"i18n:hmk-css-float",name:"float",comType:"ti-switcher",comConf:{options:[{value:"none",text:"i18n:hmk-css-float-none",icon:"fas-align-justify"},{value:"left",text:"i18n:hmk-css-float-left",icon:"fas-align-left"},{value:"right",text:"i18n:hmk-css-float-right",icon:"fas-align-right"}]}},"font-size":{title:"i18n:hmk-css-font-size",name:"font-size",comType:"ti-input"},height:{title:"i18n:hmk-css-height",name:"height",comType:"ti-input"},"letter-spacing":{title:"i18n:hmk-css-letter-spacing",name:"letter-spacing",comType:"ti-input"},"line-height":{title:"i18n:hmk-css-line-height",name:"line-height",comType:"ti-input"},margin:{title:"i18n:hmk-css-margin",name:"margin",comType:"ti-input"},"max-height":{title:"i18n:hmk-css-max-height",name:"max-height",comType:"ti-input"},"max-width":{title:"i18n:hmk-css-max-width",name:"max-width",comType:"ti-input"},"min-height":{title:"i18n:hmk-css-min-height",name:"min-height",comType:"ti-input"},"min-width":{title:"i18n:hmk-css-min-width",name:"min-width",comType:"ti-input"},"object-fit":{title:"i18n:hmk-css-object-fit",name:"object-fit",comType:"ti-droplist",comConf:{options:[{value:"fill",text:"i18n:hmk-css-object-fit-fill"},{value:"contain",text:"i18n:hmk-css-object-fit-contain"},{value:"cover",text:"i18n:hmk-css-object-fit-cover"},{value:"none",text:"i18n:hmk-css-object-fit-none"},{value:"scale-down",text:"i18n:hmk-css-object-fit-scale-down"}]}},"object-positon":{title:"i18n:hmk-css-object-position",name:"object-position",comType:"ti-input"},opacity:{title:"i18n:hmk-css-opacity",name:"opacity",type:"Number",defaultAs:1,comType:"ti-slide-bar",comConf:{className:"hdl-lg inner-color-0",width:"100%"}},overflow:{title:"i18n:hmk-css-overflow",name:"overflow",fieldWidth:"100%",comType:"ti-switcher",comConf:{options:[{value:"auto",text:"i18n:hmk-css-c-auto"},{value:"scroll",text:"i18n:hmk-css-overflow-scroll"},{value:"hidden",text:"i18n:hmk-css-overflow-hidden"},{value:"clip",text:"i18n:hmk-css-overflow-clip"},{value:"visible",text:"i18n:hmk-css-overflow-visible"}]}},padding:{title:"i18n:hmk-css-padding",name:"padding",comType:"ti-input"},"text-align":{title:"i18n:hmk-css-text-align",name:"text-align",comType:"ti-switcher",comConf:{options:[{value:"left",tip:"i18n:hmk-css-align-left",icon:"fas-align-left"},{value:"center",tip:"i18n:hmk-css-align-center",icon:"fas-align-center"},{value:"right",tip:"i18n:hmk-css-align-right",icon:"fas-align-right"},{value:"justify",tip:"i18n:hmk-css-align-justify",icon:"fas-align-justify"}]}},"text-shadow":{title:"i18n:hmk-css-text-shadow",name:"text-shadow",comType:"ti-input"},"text-transform":{title:"i18n:hmk-css-text-transform",name:"text-transform",comType:"ti-switcher",comConf:{options:[{value:"capitalize",text:"i18n:hmk-css-text-transform-capitalize"},{value:"uppercase",text:"i18n:hmk-css-text-transform-uppercase"},{value:"lowercase",text:"i18n:hmk-css-text-transform-lowercase"}]}},"text-overflow":{title:"i18n:hmk-css-text-overflow",name:"text-overflow",comType:"ti-switcher",comConf:{options:[{value:"clip",text:"i18n:hmk-css-text-overflow-clip",icon:"fas-cut"},{value:"ellipsis",text:"i18n:hmk-css-text-overflow-ellipsis",icon:"fas-ellipsis-h"}]}},width:{title:"i18n:hmk-css-width",name:"width",comType:"ti-input"},"white-space":{title:"i18n:hmk-css-white-space",name:"white-space",comType:"ti-droplist",comConf:{options:[{value:"normal",text:"i18n:hmk-css-white-space-normal"},{value:"nowrap",text:"i18n:hmk-css-white-space-nowrap"},{value:"pre",text:"i18n:hmk-css-white-space-pre"},{value:"pre-wrap",text:"i18n:hmk-css-white-space-pre-wrap"},{value:"pre-line",text:"i18n:hmk-css-white-space-pre-line"},{value:"break-space",text:"i18n:hmk-css-white-space-break-space"}]}}},e={aspect:["margin","padding","border","border-radius","color","box-shadow","opacity","object-fit","object-positon","float","overflow"],background:["color","background-color","background-image","background-position-x","background-position-y","background-size","background-repeat"],measure:["width","height","max-width","max-height","min-width","min-height"],texting:["text-align","white-space","text-overflow","text-transform","font-size","letter-spacing","line-height","text-shadow"]};return{getCssPropTitle(e){let i=t[e];return i?i.title:e},getCssPropField(e,i={}){let n=_.cloneDeep(t[e]);if(n)return _.merge(n,i)},findCssPropFields(i=!0){let n={"#BLOCK":[/^(margin|padding|border|overflow|background)-?/,/^(box-shadow|float|opacity)$/,/^((max|min)-)?(width|height)$/],"#IMG":[/^(margin|border|object|background)-?/,/^(box-shadow|float|opacity|overflow)$/,/^((max|min)-)?(width|height)$/],"#TEXT":[/^(color|background(-.+)?)$/,/^(text-(align|transform|shadow|overflow)|opacity)$/,/^(font-size|line-height|letter-spacing|white-space)$/],"#TEXT-BLOCK":[/^(padding|color||overflow)$/,/^(border|background)(-.+)?/,/^(text-(align|transform|shadow|overflow)|opacity)$/,/^(font-size|line-height|letter-spacing|white-space)$/]}[i];n&&(i=n);let a=Ti.AutoMatch.parse(i),o={};_.forEach(t,(t,e)=>{a(e)&&(o[e]=t)});let s=[];return _.forEach(e,(t,e)=>{let i=[];for(let e of t){let t=o[e];t&&i.push(t)}if(i.length>0){let t={aspect:"as-columns",background:"as-columns",measure:"as-columns",texting:"as-columns"}[e];s.push({title:`i18n:hmk-css-grp-${e}`,className:t,fields:i})}}),s}}}(),OpenObjSelector=function(){return async function(t="~",{title:e="i18n:select",icon:i="im-folder-open",type:n="info",closer:a=!0,textOk:o="i18n:ok",textCancel:s="i18n:cancel",position:r="top",width:l="80%",height:c="90%",spacing:m,multi:d=!0,titleBy:p="title|nm",fromIndex:u=0,exposeHidden:h=!1,homePath:y=Wn.Session.getHomePath(),fallbackPath:g=Wn.Session.getHomePath(),sideItems:f=[],sideWidth:w="2rem",search:b={filter:{},sorter:{nm:1}},filter:T=(t=>"FILE"==t.race),canOpen:k=(t=>"DIR"==t.race),selected:x=[]}={}){let v=t;if(_.isString(t)&&(v=await Wn.Io.loadMeta(t)),!v&&g&&t!=g&&(v=await Wn.Io.loadMeta(g)),!v)return await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:_.isString(t)?{ph:t,nm:Ti.Util.getFileName(t)}:t.ph},"warn");let O=[];for(let t of f){let e=await Wn.Io.loadMeta(t);e&&O.push({depth:0,key:e.id,id:e.id,path:e.ph,icon:Ti.Icons.get(e),title:e.title||e.nm})}return"DIR"==v.race||(v=await Wn.Io.loadMetaById(v.pid))?await Ti.App.Open({type:n,width:l,height:c,spacing:m,position:r,closer:a,icon:i,title:e,actions:[{text:o,handler:({$main:t})=>t.myChecked},{text:s,handler:()=>void 0}],modules:{axis:"@mod:wn/obj-axis",current:"@mod:wn/obj-current",main:"@mod:wn/obj-children"},comType:"modal-inner-body",components:["@com:ti/crumb","@com:wn/adaptlist","@com:wn/gui/side/nav",{name:"modal-inner-body",globally:!1,data:{myChecked:[],myShown:{side:O.length>1}},props:{icon:void 0,text:void 0,trimed:void 0,placeholder:void 0,valueCase:void 0,value:void 0},template:'<ti-gui\n          :layout="TheLayout"\n          :schema="TheSchema"\n          :shown="myShown"\n          :can-loading="true"\n          :loading-as="status.reloading"\n          @item:active="OnCurrentMetaChange"\n          @arena::open:wn:obj="OnCurrentMetaChange"\n          @arena::select="OnArenaSelect"/>',computed:{...Vuex.mapState("axis",["ancestors","parent"]),...Vuex.mapState("current",["meta","status","fieldStatus"]),...Vuex.mapState("main",["data"]),CrumbData(){let t=Wn.Obj.evalCrumbData({meta:this.meta,ancestors:this.ancestors,fromIndex:u,homePath:y,titleBy:p,iteratee:(t,e,{nm:i}={})=>{if(h||!i||!i.startsWith("."))return t}});return _.isEmpty(t)||(t[0].icon=null),t},SideConfig(){return{items:O,highlightItemId:_.get(this.meta,"id"),highlightItemPath:_.get(this.meta,"ph")}},TheLayout:()=>({type:"rows",border:!0,blocks:[{name:"sky",size:".5rem",body:"sky"},{type:"cols",border:!0,blocks:[{name:"side",size:w,body:"side"},{name:"arena",body:"main"}]}]}),TheSchema(){return{sky:{comType:"ti-crumb",comConf:{style:{padding:"0 .1rem"},data:this.CrumbData}},side:{comType:"wn-gui-side-nav",comConf:this.SideConfig},main:{comType:"wn-adaptlist",comConf:{meta:this.meta,data:this.data,status:this.status,multi:d,listConf:{resizeDelay:200},itemTitleKey:p}}}}},methods:{OnCurrentMetaChange({id:t,path:e,value:i}={}){this.open(t||e||i)},OnArenaSelect({checked:t}){_.isFunction(T)?this.myChecked=_.filter(t,t=>!!T(t)):this.myChecked=t},async open(t){if(t)if(_.isString(t)&&(t=await Wn.Io.loadMetaBy(t)),k(t)){let e=Ti.App(this);b&&(e.commit("main/setFilter",b.filter||{}),e.commit("main/setSorter",b.sorter||{nm:1})),e.commit("current/setMeta",t),e.dispatch("main/reload",t),e.dispatch("axis/reload",t)}else console.log(this.myChecked),this.$notify("ok",this.myChecked)}},mounted:function(){this.open(v)}}]}):await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:{ph:`Parent of id:${v.id}->pid:${v.pid}`,nm:`Parent of id:${v.nm}->pid:${v.pid}`}},"warn")}}(),OpenObjTree=function(){return async function(t="~",{title:e="i18n:select",icon:i="zmdi-gamepad",type:n="info",closer:a=!0,textOk:o="i18n:ok",textCancel:s="i18n:cancel",position:r="top",width:l=640,height:c="90%",spacing:m,multi:d=!1,exposeHidden:p=!1,treeDisplay:u,homePath:h=Wn.Session.getHomePath(),fallbackPath:y=Wn.Session.getHomePath(),objMatch:g={race:"DIR"},objSort:f,objFilter:w}={}){let b=await Wn.Io.loadMeta(h,{loadPath:!0}),T=t;if(_.isString(t)?T=await Wn.Io.loadMeta(t,{loadPath:!0}):T&&T.id&&!T.ph&&(T=await Wn.Io.loadMetaById(T.id,{loadPath:!0})),!T&&y&&t!=y&&(T=await Wn.Io.loadMeta(y)),!T)return await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:_.isString(t)?{ph:t,nm:Ti.Util.getFileName(t)}:t.ph},"warn");if("DIR"!=T.race&&!(T=await Wn.Io.loadMetaById(T.pid)))return await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:{ph:`Parent of id:${T.id}->pid:${T.pid}`,nm:`Parent of id:${T.nm}->pid:${T.pid}`}},"warn");let k=T,x=Wn.Io.getFormedPath(k);x.startsWith("~/")&&(x=x.substring(2));let v=Ti.Util.splitPathToFullAncestorList(x),O=await Ti.App.Open({type:n,width:l,height:c,spacing:m,position:r,closer:a,icon:i,title:e,textOk:o,textCancel:s,model:{event:"select"},comType:"WnObjTree",comConf:{meta:b,showRoot:!1,multi:d,display:u,currentId:k.id,openedNodePath:v,objMatch:g,sortBy:f,objFilter:w||function(t){return!(!p&&/^\./.test(t.nm))}},components:["@com:wn/obj/tree"]});return O&&!_.isEmpty(O.selected)?d?O.selected:O.current:void 0}}(),OpenThingManager=function(){return async function(t,{textOk:e="i18n:ok",icon:i="fas-database",title:n,ok:a=(({result:t})=>t),textCancel:o="i18n:close",position:s="top",width:r="96%",height:l="96%",spacing:c}={}){if(Ti.Util.isNil(t))return await Ti.Toast.Open("ThingSet path is nil","warn");let m=_.isString(t)?await Wn.Io.loadMeta(t):t;if(!m)return await Ti.Toast.Open(`Fail to found ThingSet: ${t}`,"warn");m.th_auto_select=!1;let d=await Wn.Sys.exec(`ti views id:${m.id} -cqn`,{as:"json"});return await Ti.App.Open({icon:i,title:n||m.title||m.nm,position:s,width:r,height:l,escape:!1,topActions:d.actions,textOk:e,textCancel:o,ok:a,modules:{current:"@mod:wn/obj-current",main:"@mod:wn/thing"},comType:"wn-thing-manager",comConf:{"...":"=Main",emitChange:!0},components:["@com:wn/thing/manager"],preload:async function(t){t.commit("current/setMeta",m),await t.dispatch("main/reload",m)}})}}(),EditObjMeta=function(){return async function(t="~",{icon:e,title:i,type:n="info",closer:a=!0,escape:o=!0,textOk:s="i18n:ok",textCancel:r="i18n:cancel",position:l="top",width:c=640,height:m="90%",spacing:d,currentTab:p=0,fields:u=[],fixedKeys:h=["icon","thumb","title"],saveKeys:y=["thumb"],autoSave:g=!0}={}){let f=t;_.isString(f)&&(f=await Wn.Io.loadMeta(t));let w={};_.forEach(h,t=>w[t]=!0);let b={};if(_.forEach(y,t=>b[t]=!0),"auto"==u){let t=await Wn.Sys.exec2(`ti metas id:${f.id} -cqn`,{as:"json"});t&&(u=t.fields,p=t.currentTab||p||0)}!_.isEmpty(u)&&_.isArray(u)||(u=[{title:"basic",fields:["id","nm","title","icon","thumb","ph","race","tp","mime","width","height","len","sha1","sort"]},{title:"privilege",fields:["c","m","g","md","pvg"]},{title:"timestamp",fields:["ct","lm","expi"]},{title:"others",fields:["..."]}]);let T=Wn.Obj.evalFields(f,u,t=>w[t.uniqKey]?t:t.quickName&&_.isUndefined(t.value)?void 0:t),k=e||Wn.Util.getObjIcon(f,"zmdi-info-outline"),x=i||Wn.Util.getObjDisplayName(f),v=await Ti.App.Open({type:n,width:c,height:m,spacing:d,position:l,closer:a,escape:o,icon:k,title:x,actions:[{text:s,handler:({$main:t})=>_.cloneDeep({updates:t.updates,data:t.meta})},{text:r,handler:({$main:t})=>{let e=_.keys(t.updates);for(let i of e)if(b[i])return _.cloneDeep({updates:t.updates,data:t.meta})}}],ready(){this.$main.meta=f},comType:"modal-inner-body",components:[{name:"modal-inner-body",globally:!1,data:{myFormFields:T,currentTab:p,meta:void 0,updates:{}},template:'<ti-form\n          mode="tab"\n          :current-tab="currentTab"\n          :fields="myFormFields"\n          :data="meta"\n          @field:change="onFieldChange"\n          @change="onChange"\n          />',methods:{onChange(t){this.meta=t},onFieldChange({name:t,value:e}={}){let i=Ti.Types.toObjByPair({name:t,value:e});this.updates=_.assign({},this.updates,i)}}},"@com:ti/form","@com:ti/input/text","@com:wn/imgfile","@com:wn/obj/mode"]});if(!v)return;let{updates:O}=v,j=!1;if(g&&!_.isEmpty(O)){let t=JSON.stringify(O),e=`obj 'id:${f.id}' -ocqn -u`,i=await Wn.Sys.exec2(e,{input:t,as:"json"});return await Ti.Toast.Open("i18n:save-done","success"),j=!0,{updates:O,data:i,saved:j}}return v}}(),EditObjContent=function(){return async function(t="~",{title:e,icon:i,type:n="info",closer:a=!0,textOk:o,textCancel:s="i18n:cancel",position:r="top",width:l="80%",height:c="96%",spacing:m,readonly:d=!1,showEditorTitle:p=!0,content:u,placeholder:h="i18n:blank",autoSave:y}={}){let g=t;_.isString(g)&&(g=await Wn.Io.loadMeta(t)),_.isUndefined(o)&&(o=this.saveBy?"i18n:save":"i18n:ok"),y=Ti.Util.fallback(y,Ti.Util.isNil(u));let f=i||Wn.Util.getObjIcon(g,"zmdi-receipt"),w=e||"i18n:edit",b=y?await Wn.Io.loadContent(g):u,T=await Ti.App.Open({type:n,width:l,height:c,spacing:m,position:r,closer:a,title:w,result:b,comType:"ti-text-raw",comConf:{readonly:d,placeholder:h,icon:f,title:Wn.Util.getObjDisplayName(g),content:b,showTitle:p,ignoreKeyUp:!0},components:["@com:ti/text/raw"]});return y&&!_.isUndefined(T)&&T!=b&&(await Wn.Io.saveContentAsText(g,T),await Ti.Toast.Open("i18n:save-done","success")),T}}(),EditObjPrivilege=function(){return async function(t="~",{icon:e="fas-user-lock",title:i="i18n:wn-key-pvg",type:n="info",closer:a=!0,escape:o=!0,position:s="top",width:r="80%",minWidth:l=720,height:c="95%",autoSave:m=!0}={}){let d=t;_.isString(d)&&(d=await Wn.Io.loadMeta(t));let p=Ti.I18n.text(i)+" : "+Ti.I18n.text(d.title||d.nm),u=await Ti.App.Open({type:n,width:r,height:c,position:s,closer:a,escape:o,icon:e,title:p,result:d.pvg,comType:"WnObjPrivilege",components:["@com:wn/obj/privilege"]});if(u&&!_.isEqual(d.pvg,u)){if(m){let t=_.isEmpty(u)?{"!pvg":!0}:{pvg:u},e=JSON.stringify(t),i=`o 'id:${d.id}' @update @json -cqn`,n=await Wn.Sys.exec2(i,{input:e,as:"json"});return await Ti.Toast.Open("i18n:save-done","success"),n}return d.pvg=u,d}}}(),EditObjPvg=function(){return async function(t="~",{icon:e="fas-user-lock",title:i="i18n:wn-key-pvg",type:n="info",closer:a=!0,escape:o=!0,position:s="top",width:r="80%",minWidth:l=720,height:c="95%",autoSave:m=!0,organization:d}={}){let p=t;_.isString(p)&&(p=await Wn.Io.loadMeta(t));let u=Ti.I18n.text(i)+" : "+Ti.I18n.text(p.title||p.nm),h=await Ti.App.Open({type:n,width:r,height:c,position:s,closer:a,escape:o,icon:e,title:u,result:p.pvg,comType:"WnObjPvg",comConf:{organization:d},components:["@com:wn/obj/pvg"]});if(h&&!_.isEqual(p.pvg,h)){if(m){let t=_.isEmpty(h)?{"!pvg":!0}:{pvg:h},e=JSON.stringify(t),i=`o 'id:${p.id}' @update @json -cqn`,n=await Wn.Sys.exec2(i,{input:e,as:"json"});return await Ti.Toast.Open("i18n:save-done","success"),n}return p.pvg=h,p}}}(),EditTiComponent=function(){return async function({comType:t,comConf:e}={},{icon:i="fas-pencil-ruler",title:n="i18n:edit-com",type:a="info",closer:o=!0,textOk:s="i18n:ok",textCancel:r="i18n:cancel",position:l="top",width:c=800,height:m="90%",spacing:d}={}){return await Ti.App.Open({type:a,width:c,height:m,spacing:d,position:l,closer:o,icon:i,title:n,textOk:s,textCancel:r,comType:"hmaker-edit-com",comConf:{value:{comType:t,comConf:e}},result:{comType:t,comConf:_.cloneDeep(e)},components:["@com:hmaker/edit-com"]})}}(),OpenCmdPanel=function(){return async function(t,{title:e="i18n:run",icon:i="fas-running",type:n="info",closer:a=!0,textCancel:o="i18n:close",position:s="top",width:r="80%",height:l="90%",spacing:c,vars:m,input:d,forceFlushBuffer:p,showRunTip:u,showTailRunTip:h,cmdTipText:y,cmdTipIcon:g,onBodyReady:f,afterRunCommand:w,whenSuccess:b,whenError:T,beforeClosed:k}={}){await Ti.App.Open({type:n,width:r,height:l,spacing:c,position:s,closer:a,icon:i,title:e,textCancel:o,textOk:null,model:null,ready:t=>{_.isFunction(f)&&f(t)},beforeClosed:k,comType:"WnCmdPanel",comConf:{value:t,tipText:y,tipIcon:g,vars:m,input:d,forceFlushBuffer:p,showRunTip:u,showTailRunTip:h,afterRunCommand:w,whenSuccess:b,whenError:T},components:["@com:wn/cmd/panel"]})}}(),Youtube=function(){const t={async getVideoDetails(t,e=[]){if(!t||_.isEmpty(e))return;let{domain:i,thumbType:n,coverType:a}=t,o=`xapi req youtube ${i} videos -url -vars '${JSON.stringify({id:e.join(","),part:t.videoPart})}'`,s=await Wn.Sys.exec2(o,{as:"text"});if(!s)throw"Fail to get youtube API(videos) URL: "+o;let r=await Ti.Http.get(s,{as:"json"});if(!r||!_.isArray(r.items))throw"Fail to load youtube playlists by: "+o;let l=[];return _.forEach(r.items,t=>{let{id:e,snippet:i,contentDetails:o}=t,s={id:e,title:i.title,publishedAt:i.publishedAt,description:i.description,thumbUrl:_.get(i,`thumbnails.${n}.url`),coverUrl:_.get(i,`thumbnails.${a}.url`),defaultLanguage:i.defaultLanguage,defaultAudioLanguage:i.defaultAudioLanguage,categoryId:i.categoryId,duration:o.duration,definition:o.definition},r=Ti.DateTime.parseTime(s.duration);s.du_in_sec=r.value,s.du_in_str=r.toString("min"),l.push(s)}),l},async getAllVideos(e,i){if(!e)return;let n=await t.getPlaylistVideos(e,i),a=n.list||[];for(;n.next;)n=await t.getPlaylistVideos(e,i,{pageToken:n.next}),a=_.concat(a,n.list);return a},async getPlaylistVideos(e,i,{pageToken:n,maxResults:a=50}={}){if(!e)return;let{domain:o}=e;i=i||e.uploadsPlaylistId;let s=`xapi req youtube ${o} playlistItems -url -vars '${JSON.stringify({playlistId:i,part:"contentDetails",pageToken:n,maxResults:a})}'`,r=await Wn.Sys.exec2(s,{as:"text"});if(!r)throw"Fail to get youtube API(playlistItems) URL: "+s;let l=await Ti.Http.get(r,{as:"json"});if(!l||!_.isArray(l.items))throw"Fail to load youtube playlistItems by: "+s;let c=[];_.forEach(l.items,t=>{let e=_.get(t.contentDetails,"videoId");c.push(e)});return{list:await t.getVideoDetails(e,c),prev:l.prevPageToken,next:l.nextPageToken}},async getAllPlaylists(e,{force:i=!1}={}){if(!e)return;let{domain:n}=e,a=[],o=!0;if(!i){let t=`~/.domain/youtube/${n}`,e=await Wn.Io.loadMeta(`${t}/playlists.json`);e&&(a=await Wn.Io.loadContent(e,{as:"json"}),o=!1)}if(o||i){let i=await t.getPlaylists(e);for(a=i.list||[];i.next;)i=await t.getPlaylists(e,{pageToken:i.next}),a=_.concat(a,i.list);let n=JSON.stringify(a);await Wn.Sys.exec2(`json -qn > ${ytHome}/playlists.json`,{input:n})}return a},async getPlaylists(t,{pageToken:e,maxResults:i=50}={}){if(!t)return;let{domain:n,channelId:a,thumbType:o}=t,s=`~/.domain/youtube/${n}`,r=JSON.stringify({channelId:a,part:t.playlistPart,pageToken:e,maxResults:i}),l=`xapi req youtube ${n} playlists -url -vars '${r}'`,c=await Wn.Sys.exec2(l,{as:"text"});if(!c)throw"Fail to get youtube API(playlist) URL: "+l;let m=await Ti.Http.get(c,{as:"json"});if(!m||!_.isArray(m.items))throw"Fail to load youtube playlists by: "+l;r=JSON.stringify(m);let d=e?`_${e}.json`:".json";await Wn.Sys.exec2(`json -qn > ${s}/results/playlists${d}`,{input:r});let p=[];return _.forEach(m.items,t=>{let{id:e,snippet:i,contentDetails:n}=t,a={id:e,title:i.title,description:i.description,thumbUrl:_.get(i,`thumbnails.${o}.url`),itemCount:n.itemCount};p.push(a)}),{list:p,prev:m.prevPageToken,next:m.nextPageToken}},async loadConfig({domain:t,channelId:e,force:i=!1}={}){t||(t=Wn.Session.getCurrentDomain());let n=`~/.domain/youtube/${t}`,a=await Wn.Io.loadMeta(`${n}/youtube.json`),o=!0,s={};if(a&&(s=await Wn.Io.loadContent(a,{as:"json"}),o=!1),_.defaults(s,{domain:t,thumbType:"high",coverType:"maxres",maxResults:50,channelId:e,channelTitle:"No Title",channelPart:"snippet,contentDetails,statistics",uploadsPlaylistId:null,playlistPart:"snippet,contentDetails,status,id,player,localizations",videoPart:"snippet,contentDetails,status,id,player"}),o||i){let i=JSON.stringify({id:e,part:s.channelPart}),a=`xapi req youtube ${t} channels -url -vars '${i}'`,o=await Wn.Sys.exec2(a,{as:"text"});if(!o)throw"Fail to get youtube API(channels) URL: "+a;let r=await Ti.Http.get(o,{as:"json"});if(!r||!_.isArray(r.items)||_.isEmpty(r.items))throw"Fail to load youtube channels by: "+a;i=JSON.stringify(r),await Wn.Sys.exec2(`json -qn > ${n}/results/channels.json`,{input:i}),s.channelTitle=_.get(r,"items.0.snippet.title"),s.uploadsPlaylistId=_.get(r,"items.0.contentDetails.relatedPlaylists.uploads"),i=JSON.stringify(s),await Wn.Sys.exec2(`json -qn > ${n}/youtube.json`,{input:i})}return s}};return t}(),FbAlbum=function(){const t={getAlbumPhotoCacheInfo({albumId:t,domain:e,accountName:i}){let n=`${e}.album.${t}.photos.json`;return{fileName:n,filePath:`~/.domain/facebook/${i}/${n}`}},async reloadAllPhotosInCache({albumId:e,domain:i,accountName:n}={}){let a=t.getAlbumPhotoCacheInfo({albumId:e,domain:i,accountName:n}),o=a.filePath;return a.oCache=await Wn.Io.loadMeta(o),a.oCache&&(a.photos=await Wn.Io.loadContent(a.oCache,{as:"json"})),a},async reloadAllPhotoList({albumId:e,domain:i,accountName:n,access_token:a,force:o=!1}={}){let s;if(o){let{filePath:a}=t.getAlbumPhotoCacheInfo({albumId:e,domain:i,accountName:n});s=a}else{let{filePath:a,photos:o}=await t.reloadAllPhotosInCache({albumId:e,domain:i,accountName:n});if(!_.isEmpty(o))return o;s=a}let r=[],l=await Ti.Api.Facebook.getAlbumPhotoList({albumId:e,access_token:a});r.push(...l.data);let c=_.get(l.paging,"cursors.after");for(;c;)l=await Ti.Api.Facebook.getAlbumPhotoList({albumId:e,access_token:a,after:c}),r.push(...l.data),c=_.get(l.paging,"cursors.after");return await t.savePhotoListToCache(r,{albumId:e,domain:i,accountName:n}),r},async savePhotoListToCache(e,{albumId:i,domain:n,accountName:a}){let{filePath:o}=t.getAlbumPhotoCacheInfo({albumId:i,domain:n,accountName:a});if(!_.isEmpty(e)&&n&&o){console.log("save to cache",o);let t=JSON.stringify(e),i=`str > ${o}`;await Wn.Sys.exec2(i,{input:t}),await Ti.Toast.Open(`${e.length} photos cached`,"success")}}};return t}(),WALNUT_VERSION="1.2-20220218.025546",HOOKs={};export const Wn={Version:WALNUT_VERSION,Io:Io,Obj:Obj,Session:Session,Sys:Sys,Util:Util,Dict:Dict,Hm:Hm,OpenObjSelector:OpenObjSelector,OpenObjTree:OpenObjTree,EditObjMeta:EditObjMeta,EditObjContent:EditObjContent,EditObjPrivilege:EditObjPrivilege,EditObjPvg:EditObjPvg,EditTiComponent:EditTiComponent,OpenThingManager:OpenThingManager,OpenCmdPanel:OpenCmdPanel,Youtube:Youtube,FbAlbum:FbAlbum,addHook(t,e){Ti.Util.pushValue(HOOKs,t,e)},doHook(t,e){let i=HOOKs[t];if(_.isArray(i)&&i.length>0)for(let t of i)t(e)}};export default Wn;window&&(window.Wn=Wn);