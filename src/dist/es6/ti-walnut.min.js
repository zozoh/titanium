const Io=function(){function t(t){return"/o/"+t}function e(t,e){if(!t.ok){if(_.isUndefined(e))throw t;return e}return t.data}const i={isFullObjId:t=>/^[0-9a-v]{26}(:.+)?$/.test(t),isFullObjIdPath:t=>/^id:[0-9a-v]{26}(:.+)?$/.test(t),async loadMetaBy(t,e){if(i.isFullObjId(t))return await i.loadMetaById(t);if(/^(id:|\/|~)/.test(t))return await i.loadMeta(t);let n;n=e?_.isString(e)?Ti.Util.getParentPath(e):"FILE"==e.race?"id:"+e.pid:"id:"+e.id:"~";let a=Ti.Util.appendPath(n,t);return await i.loadMeta(a)},loadMetaById:async t=>await i.loadMeta("id:"+t),async loadMeta(i){let n=t("fetch");return e(await Ti.Http.get(n,{params:{str:i},as:"json"}),null)},async loadMetaAt(t,e){let n=e;return t&&!/^(~\/|\/|id:)/.test(e)&&(n=`id:${t.pid}/${e}`),await i.loadMeta(n)},async loadAncestors(i){let n=t("ancestors");return e(await Ti.Http.get(n,{params:{str:i},as:"json"}),[])},async loadChildren(n,{skip:a,limit:s,sort:o={nm:1},mine:r,match:l={}}={}){if(!n)return null;if("DIR"!=n.race)return 0===s?[]:{};if(n.mnt||n.ln){let i=t("children");return e(await Ti.Http.get(i,{params:{str:`id:${n.id}`,pg:!0},as:"json"}))}l.pid=n.id;let c=await i.find({skip:a,limit:s,sort:o,mine:r,match:l});if(n.ph&&c&&_.isArray(c.list))for(let t of c.list)t.ph||(t.ph=Ti.Util.appendPath(n.ph,t.nm));return c},async find({skip:i=0,limit:n=100,sort:a={},mine:s=!0,match:o={}}={}){let r=t("find");return e(await Ti.Http.get(r,{params:_.assign({},o,{_l:n,_o:i,_me:s,_s:JSON.stringify(a)}),as:"json"}))},async findList(t={}){let e=await i.find(t);return e&&_.isArray(e.list)?e.list:[]},async findInBy(t,e,{skip:n=0,limit:a=100,sort:s={},mine:o=!0,match:r={},keys:l={"^[0-9a-v]{26}(:.+)$":["id","${val}"]},dftKey:c=["nm","^.*${val}.*$"]}={}){if(!_.isUndefined(t)){let e=c;for(let i of _.keys(l))if(new RegExp(i).test(t)){e=l[i];break}let i=e[0],n=Ti.S.renderBy(e[1],{val:t});r[i]=n}if(e&&e.id&&e.ph)r.pid=e.id;else if(_.isString(e)){let t=await i.loadMeta(e);r.pid=t.id}return await i.find({skip:n,limit:a,sort:s,mine:o,match:r})},async findListInBy(t,e,n={}){let a=await i.findInBy(t,e,n);return a&&_.isArray(a.list)?a.list:[]},async loadContent(e,{as:n="text"}={}){if(_.isString(e)&&(e=await i.loadMeta(e)),!e||"DIR"==e.race)return null;let a=e.mime||"application/octet-stream";if(Wn.Util.isMimeText(a)){let i=t("content");return await Ti.Http.get(i,{params:{str:"id:"+e.id,d:"raw"},as:n})}return e.sha1},async update(e,n={}){if(!e||_.isEmpty(n))return;if(_.isString(e)&&(e=await i.loadMetaBy(e)),!_.isPlainObject(e))throw Ti.Err.make("e-wn-io-invalidUpdateTarget",e);let a=t("/update"),s=await Ti.Http.post(a,{params:{str:"id:"+e.id},body:JSON.stringify(n),as:"json"});if(!s.ok)throw Ti.Err.make(s.errCode,s.data,s.msg);return s.data},async saveContentAsText(e,n){if(!e)return;if(Ti.Util.isNil(n)&&(n=""),_.isString(e)&&(e=await i.loadMetaBy(e)),!_.isPlainObject(e))throw Ti.Err.make("e-wn-io-invalidTarget",e);if("DIR"==e.race)throw Ti.Err.make("e-wn-io-writeNoFile",e.ph||e.nm);let a={str:"id:"+e.id,content:n},s=t("/save/text"),o=await Ti.Http.post(s,{params:a,as:"json"});if(!o.ok)throw Ti.Err.make(o.errCode,o.data,o.msg);return o.data},async uploadFile(e,{target:i="~",mode:n="a",tmpl:a="${major}(${nb})${suffix}",progress:s=_.identity}={}){let o=t("/save/stream");return await Ti.Http.post(o,{file:e,progress:s,params:{str:i,nm:e.name,sz:e.size,mime:e.type,m:n,tmpl:a},as:"json"})},getFormedPath(t){let e=t.ph?t.ph:t,i=Wn.Session.getHomePath(),n=Ti.Util.getRelativePath(i,e,"");return Ti.Util.appendPath("~",n)},formatObjPath(t,e,n){let a={path:()=>n?Ti.Util.getRelativePath(n.ph,t.ph):i.getFormedPath(t.ph),fullPath:()=>t.ph,idPath:()=>`id:${t.id}`,id:()=>t.id,obj(){let e=n||["id","nm","thumb","title","mime","tp","sha1","len"];return _.pick(t,e)}}[e];if(!a)throw"Invalid mode : "+e;return a()}};return i}(),Obj=function(){const t={id:{title:"i18n:wn-key-id",name:"id",comType:"WnObjId"},nm:{title:"i18n:wn-key-nm",name:"nm",display:"<=ti-label>",comType:"ti-input"},title:{title:"i18n:wn-key-title",name:"title",emptyAs:null,display:"<=ti-label>",comType:"ti-input"},sort:{title:"i18n:sort",name:"sort",tip:"i18n:sort-tip-asc",type:"Integer",comType:"ti-input-num",comConf:{width:140}},icon:{title:"i18n:wn-key-icon",name:"icon",width:"auto",comType:"ti-input-icon"},ph:{title:"i18n:wn-key-ph",name:"ph",comConf:{className:"is-break-word"}},thumb:{title:"i18n:wn-key-thumb",name:"thumb",checkEquals:!1,serializer:{name:"Ti.Types.toStr",args:"id:${id}"},comType:"wn-imgfile",comConf:{target:"~/.thumbnail/gen/${id}.jpg",filter:"cover(256,256)",quality:.372}},race:{title:"i18n:wn-key-race",name:"race",comConf:{format:"i18n:wn-race-${race}"}},mime:{title:"i18n:wn-key-mime",name:"mime"},tp:{title:"i18n:wn-key-tp",name:"tp"},ct:{title:"i18n:wn-key-ct",name:"ct",type:"AMS"},lm:{title:"i18n:wn-key-lm",name:"lm",type:"AMS"},expi:{title:"i18n:wn-key-expi",name:"expi",type:"AMS"},pid:{title:"i18n:wn-key-pid",name:"pid"},d0:{title:"i18n:wn-key-d0",name:"d0"},d1:{title:"i18n:wn-key-d1",name:"d1"},c:{title:"i18n:wn-key-c",name:"c"},m:{title:"i18n:wn-key-m",name:"m"},g:{title:"i18n:wn-key-g",name:"g"},data:{title:"i18n:wn-key-data",name:"data"},sha1:{title:"i18n:wn-key-sha1",name:"sha1",comConf:{className:"is-nowrap",fullField:!1}},md:{title:"i18n:wn-key-md",name:"md",type:"Integer",comType:"WnObjMode",comConf:{valueType:"decimal"}},pvg:{title:"i18n:wn-key-pvg",name:"pvg",type:"Object",comType:"TiInputText",comConf:{autoJsValue:!0,height:200}},width:{title:"i18n:wn-key-width",name:"width"},height:{title:"i18n:wn-key-height",name:"height"},duration:{title:"i18n:wn-key-duration",name:"duration",width:"auto",comConf:{suffixText:"i18n:tu-sec"}},len:{title:"i18n:wn-key-len",name:"len",width:"auto",transformer:t=>Ti.S.sizeText(t,{bytes:!0})}},e={isValidName:t=>!t||t.search(/[%;:"'*?`\t^<>\/\\]/)>=0?(Ti.Alert("i18n:wn-rename-invalid",{type:"warn"}),!1):!(t.length>256)||(Ti.Alert("i18n:wn-rename-too-long",{type:"warn"}),!1),octalModeToStr(t){let i=parseInt(t,8);return e.modeToStr(i)},modeToStr(t){let e=[];for(let i=2;i>=0;i--){let n=t>>3*i&7;e.push((4&n)>0?"r":"-"),e.push((2&n)>0?"w":"-"),e.push((1&n)>0?"x":"-")}return e.join("")},modeToOctal:t=>t.toString(8),octalModeFromStr:t=>e.modeFromStr(t).toString(8),modeFromOctalMode:t=>parseInt(t,8),modeFromStr(t){let i=0;for(let n=0;n<3;n++){let a=3*(2-n),s=t.substring(a,a+3);i|=e.modeFromStr0(s)<<3*n}return i},modeFromStr0(t){let e=0;return"r"==t[0]&&(e|=4),"w"==t[1]&&(e|=2),"x"==t[2]&&(e|=1),e},modeToObj(t){let i=["other","member","owner"],n={mode:t,text:e.modeToStr(t),octal:t.toString(8)};for(let e=2;e>=0;e--){let a=t>>3*e&7;n[i[e]]={readable:(4&a)>0,writable:(2&a)>0,excutable:(1&a)>0}}return n},modeFromObj:({owner:t,member:i,other:n}={})=>e.mode0FromObj(t)<<6|e.mode0FromObj(i)<<3|e.mode0FromObj(n),mode0FromObj({readable:t,writable:e,excutable:i}={}){let n=0;return t&&(n|=4),e&&(n|=2),i&&(n|=1),n},parseMode(t,i=!1){let n=0;return/^\{.+\}$/.test(t)&&(t=JSON.parse(t)),_.isPlainObject(t)?t.readable?e.mode0FromObj(t):e.modeFromObj(t):(n=/^[rwx-]{3,9}$/.test(t)?3==t.length?e.modeFromStr0(t):e.modeFromStr(t):/^0[0-7]{3}$/.test(t)?e.modeFromOctalMode(t.substring(1)):i?e.modeFromOctalMode(t):parseInt(t),e.modeToObj(n))},isBuiltInFields:e=>!!t[e],getGroupTitle:t=>/^(basic|privilege|thumb|timestamp|more|advance|customized|others)$/.test(t)?`i18n:wn-key-grp-${t}`:t,getField(e){let i=t[e];return i?_.cloneDeep(i):{title:e,name:e,type:"String"}},evalFields(t={},e=[],i=_.identity){const n=function(e=[],i=[],a={}){return _.forEach(e,e=>{if("..."==e)return void i.push(e);let s,o=!1;if(_.isString(e))o=!0,s=Wn.Obj.getField(e);else if(_.isArray(e.fields)){if(s={title:Wn.Obj.getGroupTitle(e.title),type:"Group",fields:[]},n(e.fields,s.fields,a),_.isEmpty(s.fields))return}else s=e;let r=Ti.S.join([s.name],"-");a[r]=!0;let l=_.get(t,s.name);i.push(_.assign(s,{quickName:o,uniqKey:r,value:l}))}),i},a=function(e=[],n=[],s={}){for(let o of e)if("Group"!=o.type)if("..."==o)_.forEach(t,(t,e)=>{if(Ti.Util.isNil(t)||Wn.Obj.isBuiltInFields(e)||s[e]||"children"==e||e.startsWith("_"))return;let a={Integer:{type:"Number",display:e,comType:"ti-input"},Number:{type:"Number",display:e,comType:"ti-input"},Boolean:{type:"Boolean",comType:"ti-toggle"},Array:{type:"Array",display:{key:e},transformer:"JSON.stringify(null, '  ')",comType:"ti-input-text",comConf:{height:240}}}[Ti.Types.getJsType(t,"String")]||{type:"String",display:{key:e,comConf:{width:"100%",className:_.isString(t)&&t.length>20?"is-break-word":"is-nowrap"}},comType:"ti-input"},o=i({title:e,name:e,...a});o&&n.push(o)});else{let t=i(o);t&&n.push(t)}else o.fields=a(o.fields,[],s),_.isEmpty(o.fields)||n.push(o);return n};let s={},o=n(e,[],s);return o=a(o,[],s)},isAs(t={},i,n){let a=_.get(t,i);if(Ti.Util.isNil(a))return!1;if(_.isArray(n)){for(let a of n)if(e.isAs(t,i,a))return!0;return!1}return _.isString(n)?n.startsWith("^")?new RegExp(n).test(a):n.startsWith("!^")?!new RegExp(n.substring(1)).test(a):a==n:!!_.isRegExp(n)&&n.test(a)},isMime:(t={},i)=>e.isAs(t,"mime",i),isType:(t={},i)=>e.isAs(t,"type",i),evalCrumbData({meta:t,ancestors:e=[],fromIndex:i=0,homePath:n=null,titleBy:a,iteratee:s=_.identity,self:o=_.identity}={}){let r=[];if(t){let l=_.map(e),c=i;if(n)for(n.endsWith("/")&&(n=n.substring(0,n.length-1));c<l.length;c++){if(l[c].ph==n)break}for(;c<l.length;c++){let t=l[c],e={icon:Wn.Util.getIconObj(t),text:Wn.Util.getObjDisplayName(t,a),value:t.id,href:Wn.Util.getAppLink(t)+""};(e=s(e,c,t))&&r.push(e)}if(o){let e={icon:Wn.Util.getIconObj(t),text:Wn.Util.getObjDisplayName(t,a),value:t.id,href:null,asterisk:_.get(this.mainStatus,"changed")};_.isFunction(o)&&(e=o(e,c,t)||e),e&&r.push(e)}}return r}};return e}(),Session=function(){const t={},e={},i={setup({id:t,uid:n,unm:a,grp:s,envs:o={}}={}){_.assign(e,{id:t,uid:n,unm:a,grp:s}),i.env(o)},env(e){if(_.isPlainObject(e))_.assign(t,e);else{if(_.isString(e))return t[e];if(_.isArray(e))return _.pick(t,e)}return _.cloneDeep(t)},getLang:()=>i.env("LANG"),getMyId:()=>e.uid,getMyName:()=>e.unm,getMyGroup:()=>e.grp,getHomePath:()=>i.env("HOME"),getCurrentPath:(t="~")=>i.env("PWD")||t,getCurrentDomain(){let t=i.getHomePath();if(!t)return;if("/root"==t)return"root";let e=/^\/home\/(.+)$/.exec(t);return e?e[1]:void 0},getApiPrefix:()=>`/api/${i.getCurrentDomain()}`,getApiUrl(t){let e=i.getApiPrefix();return Ti.Util.appendPath(e,t)}};return i}(),Sys=function(){const WnSysRespParsing=function(){class t{constructor({macroObjSep:t,eachLine:e=_.identity,macro:i={}}={}){this.macroObjSep=t,this.lastIndex=0,this.lines=[],this.MACRO={},this.__TO=null,this.eachLine=e,this.macro=i}init(t){this.content=t}done(){this.updated({isLastCalled:!0}),_.forOwn(this.MACRO,(t,e)=>{let i=t.join("\n"),n=JSON.parse(i);this.MACRO[e]=n,Ti.InvokeBy(this.macro,e,[n])})}__push_line(t){if(t.startsWith(this.macroObjSep)){let e=t.substring(this.macroObjSep.length).trim(),[i,n]=_.without(e.split(/ *: */g),""),a=this[i];a&&(a[n]=[]),this.__TO={key:i,name:n}}else if(this.__TO){let{key:e,name:i}=this.__TO;this[e][i].push(t)}else this.lines.push(t),this.eachLine(t)}updated({isLastCalled:t=!1}={}){let e=this.content();for(;this.lastIndex<e.length;){let i=e.indexOf("\n",this.lastIndex);if(i>=this.lastIndex){let t=i+1;i>0&&"\r"==e[i-1]&&i--;let n=e.substring(this.lastIndex,i);this.__push_line(n),this.lastIndex=t}else{if(!t)break;{let t=e.substring(this.lastIndex);this.__push_line(t),this.lastIndex=e.length}}}}getResult(){return{lines:this.lines,macro:this.MACRO}}}return t}(),DFT_MACRO_OBJ_SEP="%%wn.meta."+Ti.Random.str(10)+"%%",WnSys={async exec(cmdText,{vars:vars={},input:input="",appName:appName=Ti.GetAppName(),eachLine:eachLine,as:as="text",blankAs:blankAs="",macroObjSep:macroObjSep=DFT_MACRO_OBJ_SEP,autoRunMacro:autoRunMacro=!0,forceFlushBuffer:forceFlushBuffer=!1,errorBy:errorBy,PWD:PWD=Wn.Session.getCurrentPath()}={}){cmdText=Ti.S.renderBy(cmdText,vars);let url=`/a/run/${appName}`,params={mos:macroObjSep,PWD:PWD,cmd:cmdText,in:input,ffb:forceFlushBuffer},ing={eachLine:eachLine,macroObjSep:macroObjSep};autoRunMacro&&(ing.macro={update_envs:t=>{Wn.Session.env(t),Wn.doHook("update_envs",t)}});let parsing=new WnSysRespParsing(ing),readyStateChanged=void 0;forceFlushBuffer&&_.isFunction(eachLine)&&(readyStateChanged=(()=>{parsing.updated()})),await Ti.Http.send(url,{method:"POST",params:params,as:"text",created:t=>{parsing.init(()=>t.responseText)},readyStateChanged:readyStateChanged}).catch(t=>{parsing.isError=!0}).finally(()=>{parsing.done()});let re=parsing.getResult();if(Ti.IsInfo("Wn.Sys")&&console.log("Wn.Sys.exec@return",re),parsing.isError){let t=re.lines.join("\n");if(_.isFunction(errorBy)){let[e,...i]=t.split(/ *: */),n=i.join(" : ");e=_.trim(e);let a=e.replace(/[.]/g,"-");return errorBy({code:e,msgKey:a,data:n})}throw t}return{raw:()=>re,lines:()=>re.lines,macro:()=>re.macro,text:()=>re.lines.join("\n"),json:()=>{let t=re.lines.join("\n");Ti.S.isBlank(t)&&(t=blankAs);try{return JSON.parse(t)}catch(e){throw console.error(`Error [${cmdText}] for parse JSON:`,t),e}},jso:()=>{let json=re.lines.join("\n");Ti.S.isBlank(json)&&(json=blankAs);try{return eval("("+json+")")}catch(t){throw console.error(`Error [${cmdText}] for eval JSO:`,json),t}}}[as]()},exec2:async(t,e={})=>(_.defaults(e,{errorBy:async function({code:t,msgKey:i,data:n}){let a=Ti.I18n.get(i);return Ti.Util.isNil(n)||_.isString(n)&&!n||(a+=" : "+Ti.Types.toStr(n)),await Ti.Alert(a,{title:"i18n:warn",type:"error"}),_.isFunction(e.errorAs)?e.errorAs({code:t,msgKey:i,data:n}):Ti.Err.make(t,n)}}),await Wn.Sys.exec(t,e)),execJson:async(t,e={as:"json"})=>await WnSys.exec(t,e),exec2Json:async(t,e={as:"json"})=>await WnSys.exec2(t,e)};return WnSys}(),Util=function(){const t={isMimeText:t=>/^text\//.test(t)||"application/x-javascript"==t||"application/json"==t,isMimeJson:t=>"text/json"==t||"application/json"==t,getIconName(t){let e=/^<i +class=["'] *(fa|zmdi|im) +(fa|zmdi|im)-([^" ]+) *["']> *<\/i>$/.exec(t);return e?e[3]:t},genPreviewObj(e){if(e.thumb)return/https?:\/\//.test(e.thumb)?{type:"image",value:e.thumb}:{type:"image",value:"/o/thumbnail/id:"+e.id};if(e.icon){let i=t.getIconName(e.icon);return Ti.Icons.get(i,{type:"font",value:i})}return Ti.Icons.get(e)},getIconObj:t=>t&&t.icon?t.icon:Ti.Icons.get(t),getObjIcon:(t,e)=>t?t.icon||Ti.Icons.get(t):e,getObjThumbIcon({icon:t,thumb:e,mime:i,type:n,race:a,candidateIcon:s,timestamp:o=0}={},r){if(e){let t=`/o/content?str=${e}`;return o>0&&(t+=`&_t=${o}`),{type:"image",value:t}}return t?{type:"font",value:t}:s||(n||i||a?Ti.Icons.get({type:n,mime:i,race:a}):r)},getObjThumbIcon2(t,e){if(t.thumb){return{type:"image",value:`/o/content?str=${t.thumb}`}}return t.icon?t.icon:e||Ti.Icons.get(t)},getObjDisplayName:(t,e=[])=>Ti.Util.getFallbackEmpty(t,e,"title","nm"),getAppLink:(e,{appName:i="wn.manager",encoded:n=!1}={})=>t.getLink(`/a/open/${i}`,e,{pathKey:"ph",encoded:n}),getAppLinkStr:(e,i)=>t.getAppLink(e,i).toString(),getObjBadges(t={},e){if(_.isFunction(e))return e(t);let{NW:i=null,NE:n=["ln","zmdi-open-in-new"],SW:a=null,SE:s=null}=e||{},o={},r=function(e,i){if(_.isFunction(i)&&(i=i(t)),i)if(_.isArray(i))1==i.length?o[e]=i[0]:i.length>1&&t[i[0]]&&(o[e]=i[1]);else if(i.test&&i.value&&i.value){if(Ti.AutoMatch.test(i.test,t)){let n=Ti.Util.explainObj(t,{type:i.type||"icon",className:i.className,value:i.value});n&&(o[e]=n)}}else o[e]=i};return r("NW",i),r("NE",n),r("SW",a),r("SE",s),o},getObjThumbInfo(e={},{exposeHidden:i=!1,status:n={},progress:a={},badges:s,titleKey:o}={}){if(!e||!e.nm)return;let r="show";return e.nm.startsWith(".")&&i&&(r=i?"weak":"hide"),{id:e.id,nm:e.nm,title:t.getObjDisplayName(e,o),preview:t.genPreviewObj(e),href:t.getAppLinkStr(e),visibility:r,status:n[e.id],progress:a[e.id],badges:t.getObjBadges(e,s)}},getDownloadLink:(e,{mode:i="force"}={})=>t.getLink("/o/content",e,{pathKey:"str",encoded:!0,params:{d:i}}),getMatchByFilter({keyword:t,match:e,majorKey:i,majorValue:n}={},a={}){let s={};if(t)if(/"^[\d\w]{26}(:.+)?$"/.test(t))s.id=t;else{let e=a.defaultKey||"nm",i=_.cloneDeep(a.keyword),n=_.keys(i);for(let a of n){let n=i[a];if(new RegExp(n).test(t)){e=a;break}}e.startsWith("=")?s[e.substring(1).trim()]=t:e.startsWith("~")?s[e.substring(1).trim()]="^"+t:s[e]="^.*"+t}_.isEmpty(e)||_.assign(s,e),i&&!Ti.Util.isNil(n)&&_.set(s,i,n);let o=a.match;return _.isEmpty(o)||_.assign(s,o),s},getLink(t,e,{pathKey:i="ph",encoded:n=!1,params:a={}}={}){let s={...a};if(!e)return{url:t,params2:s};const o=t=>n?encodeURIComponent(t):t;return/^(\/|~|id:)/.test(e)?s[i]=o(e):_.isString(e)?s[i]=`id:${e}`:e.id?s[i]=`id:${e.id}`:e.ph&&(s[i]=o(e.ph)),Ti.Util.Link({url:t,params:s})},wrapTreeNode(t){if(_.isPlainObject(t)){let e={id:t.id,name:t.nm,leaf:"DIR"!=t.race,rawData:t};if(e.leaf||(e.children=[]),e.id&&e.name)return e}},genQuery:(t,{vkey:e="val",wrapArray:i=!1,errorAs:n,blankAs:a="[]"}={})=>_.isFunction(t)?t:_.isArray(t)?i?()=>t:t:_.isString(t)?e?async i=>{let s=Ti.S.renderBy(t,{[e]:i});return await Wn.Sys.exec2(s,{as:"json",input:i,errorAs:n,blankAs:a})}:async e=>await Wn.Sys.exec2(t,{as:"json",errorAs:n,blankAs:a}):void 0};return t}(),Dict={evalOptionsDict({options:t,findBy:e,itemBy:i,childrenBy:n,valueBy:a,textBy:s,iconBy:o,dictShadowed:r=!0},l){let c=Ti.DictFactory.DictReferName(t);return c?Ti.DictFactory.CheckDict(c,l):Ti.DictFactory.CreateDict({data:Wn.Util.genQuery(t,{vkey:null,blankAs:"[]"}),query:Wn.Util.genQuery(e,{blankAs:"[]"}),item:Wn.Util.genQuery(i,{errorAs:null,blankAs:"{}"}),children:Wn.Util.genQuery(n,{errorAs:null,blankAs:"[]"}),getValue:Ti.Util.genGetter(a||"id|value"),getText:Ti.Util.genGetter(s||"title|text|nm"),getIcon:Ti.Util.genGetter(o||Wn.Util.getObjThumbIcon)},{shadowed:r,hooks:l})},setup(t){_.forEach(t,(t,e)=>{Ti.DictFactory.GetDict(e)||Ti.DictFactory.CreateDict({data:Wn.Util.genQuery(t.data,{vkey:null}),query:Wn.Util.genQuery(t.query),item:Wn.Util.genQuery(t.item,{blankAs:"{}"}),children:Wn.Util.genQuery(t.children),getValue:Ti.Util.genGetter(t.value),getText:Ti.Util.genGetter(t.text),getIcon:Ti.Util.genGetter(t.icon),shadowed:Ti.Util.fallback(t.shadowed,!0)},{name:e})})},hMakerComponents:()=>Ti.DictFactory.GetOrCreate({data:Wn.Util.genQuery("ti coms -cqn",{vkey:null}),getValue:t=>t.name,getText:t=>t.title||t.name,getIcon:t=>t.icon||"im-plugin",isMatched:(t,e)=>{if(t.name==e||t.title==e)return!0;if(t.name&&t.name.indexOf(e)>=0)return!0;if(t.title){if(t.title.indexOf(e)>=0)return!0;let i=Ti.I18n.text(t.title);if(i&&i.indexOf(e)>=0)return!0}return!1},shadowed:!0},{name:"hMakerComponents"})},Hm=function(){const t={background:{title:"i18n:hmk-css-background",name:"background",comType:"ti-input"},border:{title:"i18n:hmk-css-border",name:"border",comType:"ti-input"},"border-radius":{title:"i18n:hmk-css-border-radius",name:"border-radius",comType:"ti-input"},"box-shadow":{title:"i18n:hmk-css-box-shadow",name:"box-shadow",comType:"ti-input"},color:{title:"i18n:hmk-css-color",name:"color",comType:"ti-input-color"},float:{title:"i18n:hmk-css-float",name:"float",fieldWidth:"100%",comType:"ti-switcher",comConf:{options:[{value:"none",text:"i18n:hmk-css-float-none",icon:"fas-align-justify"},{value:"left",text:"i18n:hmk-css-float-left",icon:"fas-align-left"},{value:"right",text:"i18n:hmk-css-float-right",icon:"fas-align-right"}]}},"font-size":{title:"i18n:hmk-css-font-size",name:"font-size",comType:"ti-input"},height:{title:"i18n:hmk-css-height",name:"height",comType:"ti-input"},"letter-spacing":{title:"i18n:hmk-css-letter-spacing",name:"letter-spacing",comType:"ti-input"},"line-height":{title:"i18n:hmk-css-line-height",name:"line-height",comType:"ti-input"},margin:{title:"i18n:hmk-css-margin",name:"margin",comType:"ti-input"},"max-height":{title:"i18n:hmk-css-max-height",name:"max-height",comType:"ti-input"},"max-width":{title:"i18n:hmk-css-max-width",name:"max-width",comType:"ti-input"},"min-height":{title:"i18n:hmk-css-min-height",name:"min-height",comType:"ti-input"},"min-width":{title:"i18n:hmk-css-min-width",name:"min-width",comType:"ti-input"},overflow:{title:"i18n:hmk-css-overflow",name:"overflow",fieldWidth:"100%",comType:"ti-switcher",comConf:{options:[{value:"auto",text:"i18n:hmk-css-c-auto"},{value:"scroll",text:"i18n:hmk-css-overflow-scroll"},{value:"hidden",text:"i18n:hmk-css-overflow-hidden"},{value:"clip",text:"i18n:hmk-css-overflow-clip"},{value:"visible",text:"i18n:hmk-css-overflow-visible"}]}},padding:{title:"i18n:hmk-css-padding",name:"padding",comType:"ti-input"},"text-shadow":{title:"i18n:hmk-css-text-shadow",name:"text-shadow",comType:"ti-input"},"text-transform":{title:"i18n:hmk-css-text-transform",name:"text-transform",fieldWidth:"100%",comType:"ti-switcher",comConf:{options:[{value:"capitalize",text:"i18n:hmk-css-text-transform-capitalize"},{value:"uppercase",text:"i18n:hmk-css-text-transform-uppercase"},{value:"lowercase",text:"i18n:hmk-css-text-transform-lowercase"},{value:"none",text:"i18n:hmk-css-text-transform-none"}]}},"text-align":{title:"i18n:hmk-css-text-align",name:"text-align",fieldWidth:"100%",comType:"ti-switcher",comConf:{options:[{value:"left",text:"i18n:hmk-css-align-left",icon:"fas-align-left"},{value:"center",text:"i18n:hmk-css-align-center",icon:"fas-align-center"},{value:"right",text:"i18n:hmk-css-align-right",icon:"fas-align-right"},{value:"justify",text:"i18n:hmk-css-align-justify",icon:"fas-align-justify"}]}},width:{title:"i18n:hmk-css-width",name:"width",comType:"ti-input"}},e={aspect:["margin","padding","border","border-radius","background","color","box-shadow","float","overflow"],measure:["width","height","max-width","max-height","min-width","min-height"],texting:["text-align","text-transform","font-size","letter-spacing","line-height","text-shadow"]};return{getCssPropTitle(e){let i=t[e];return i?i.title:e},getCssPropField(e,i={}){let n=_.cloneDeep(t[e]);if(n)return _.merge(n,i)},findCssPropFields(i=!0){let n=Ti.AutoMatch.parse(i),a={};_.forEach(t,(t,e)=>{n(e)&&(a[e]=t)});let s=[];return _.forEach(e,(t,e)=>{let i=[];for(let e of t){let t=a[e];t&&i.push(t)}if(i.length>0){let t={aspect:"as-vertical col-2",measure:"as-vertical col-2",texting:"as-vertical col-2"}[e];s.push({title:`i18n:hmk-css-grp-${e}`,className:t,fields:i})}}),s}}}(),OpenObjSelector=function(){return async function(t="~",{title:e="i18n:select",icon:i="im-folder-open",type:n="info",closer:a=!0,textOk:s="i18n:ok",textCancel:o="i18n:cancel",position:r="top",width:l="80%",height:c="90%",spacing:m,multi:d=!0,titleBy:p="title|nm",fromIndex:u=0,exposeHidden:h=!1,homePath:g=Wn.Session.getHomePath(),fallbackPath:y=Wn.Session.getHomePath(),sideItems:f=[],sideWidth:w="2rem",search:T={filter:{},sorter:{nm:1}},filter:b=(t=>"FILE"==t.race),canOpen:x=(t=>"DIR"==t.race),selected:k=[]}={}){let v=t;if(_.isString(t)&&(v=await Wn.Io.loadMeta(t)),!v&&y&&t!=y&&(v=await Wn.Io.loadMeta(y)),!v)return await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:_.isString(t)?{ph:t,nm:Ti.Util.getFileName(t)}:t.ph},"warn");let O=[];for(let t of f){let e=await Wn.Io.loadMeta(t);e&&O.push({depth:0,key:e.id,id:e.id,path:e.ph,icon:Ti.Icons.get(e),title:e.title||e.nm})}return"DIR"==v.race||(v=await Wn.Io.loadMetaById(v.pid))?await Ti.App.Open({type:n,width:l,height:c,spacing:m,position:r,closer:a,icon:i,title:e,actions:[{text:s,handler:({$main:t})=>t.myChecked},{text:o,handler:()=>void 0}],modules:{axis:"@mod:wn/obj-axis",current:"@mod:wn/obj-current"},comType:"modal-inner-body",components:["@com:ti/crumb","@com:wn/adaptlist","@com:wn/gui/side/nav",{name:"modal-inner-body",globally:!1,data:{myChecked:[],myShown:{side:O.length>1}},props:{icon:void 0,text:void 0,trimed:void 0,placeholder:void 0,valueCase:void 0,value:void 0},template:'<ti-gui\n          :layout="TheLayout"\n          :schema="TheSchema"\n          :shown="myShown"\n          :can-loading="true"\n          :loading-as="status.reloading"\n          @item:active="OnCurrentMetaChange"\n          @arena::open:wn:obj="OnCurrentMetaChange"\n          @arena::select="OnArenaSelect"/>',computed:{...Vuex.mapState("axis",["ancestors","parent"]),...Vuex.mapState("current",["meta","content","data","status","fieldStatus"]),CrumbData(){let t=Wn.Obj.evalCrumbData({meta:this.meta,ancestors:this.ancestors,fromIndex:u,homePath:g,titleBy:p,iteratee:(t,e,{nm:i}={})=>{if(h||!i||!i.startsWith("."))return t}});return _.isEmpty(t)||(t[0].icon=null),t},SideConfig(){return{items:O,highlightItemId:_.get(this.meta,"id"),highlightItemPath:_.get(this.meta,"ph")}},TheLayout:()=>({type:"rows",border:!0,blocks:[{name:"sky",size:".5rem",body:"sky"},{type:"cols",border:!0,blocks:[{name:"side",size:w,body:"side"},{name:"arena",body:"main"}]}]}),TheSchema(){return{sky:{comType:"ti-crumb",comConf:{style:{padding:"0 .1rem"},data:this.CrumbData}},side:{comType:"wn-gui-side-nav",comConf:this.SideConfig},main:{comType:"wn-adaptlist",comConf:{meta:this.meta,data:this.data,status:this.status,multi:d,listConf:{resizeDelay:200}}}}}},methods:{OnCurrentMetaChange({id:t,path:e,value:i}={}){this.open(t||e||i)},OnArenaSelect({checked:t}){_.isFunction(b)?this.myChecked=_.filter(t,b):this.myChecked=t},async open(t){if(t)if(_.isString(t)&&(t=await Wn.Io.loadMetaBy(t)),x(t)){let e=Ti.App(this);T&&(e.commit("current/setFilter",T.filter||{}),e.commit("current/setSorter",T.sorter||{nm:1})),e.dispatch("current/reload",t),e.dispatch("axis/reload",t)}else console.log(this.myChecked),this.$notify("ok",this.myChecked)}},mounted:function(){this.open(v)}}]}):await Ti.Toast.Open({content:"i18n:e-io-obj-noexistsf",vars:{ph:`Parent of id:${v.id}->pid:${v.pid}`,nm:`Parent of id:${v.nm}->pid:${v.pid}`}},"warn")}}(),OpenThingManager=function(){return async function(t,{textOk:e="i18n:ok",icon:i="fas-database",title:n,ok:a=(({result:t})=>t),textCancel:s="i18n:close",position:o="top",width:r="96%",height:l="96%",spacing:c}={}){if(Ti.Util.isNil(t))return await Ti.Toast.Open("ThingSet path is nil","warn");let m=_.isString(t)?await Wn.Io.loadMeta(t):t;if(!m)return await Ti.Toast.Open(`Fail to found ThingSet: ${t}`,"warn");m.th_auto_select=!1;let d=await Wn.Sys.exec(`ti views id:${m.id} -cqn`,{as:"json"});return await Ti.App.Open({icon:i,title:n||m.title||m.nm,position:o,width:r,height:l,escape:!1,topActions:d.actions,textOk:e,textCancel:s,ok:a,modules:{current:"@mod:wn/obj-current",main:"@mod:wn/thing"},comType:"wn-thing-manager",comConf:{"...":"=Main",emitChange:!0},components:["@com:wn/thing/manager"],preload:async function(t){t.commit("current/setMeta",m),await t.dispatch("main/reload",m)}})}}(),EditObjMeta=function(){return async function(t="~",{icon:e,title:i,type:n="info",closer:a=!0,escape:s=!0,textOk:o="i18n:ok",textCancel:r="i18n:cancel",position:l="top",width:c=640,height:m="90%",spacing:d,currentTab:p=0,fields:u=[],fixedKeys:h=["icon","thumb","title"],saveKeys:g=["thumb"],autoSave:y=!0}={}){let f=t;_.isString(f)&&(f=await Wn.Io.loadMeta(t));let w={};_.forEach(h,t=>w[t]=!0);let T={};if(_.forEach(g,t=>T[t]=!0),"auto"==u){let t=await Wn.Sys.exec2(`ti metas id:${f.id} -cqn`,{as:"json"});t&&(u=t.fields,p=t.currentTab||p||0)}!_.isEmpty(u)&&_.isArray(u)||(u=[{title:"basic",fields:["id","nm","title","icon","thumb","ph","race","tp","mime","width","height","len","sha1","sort"]},{title:"privilege",fields:["c","m","g","md","pvg"]},{title:"timestamp",fields:["ct","lm","expi"]},{title:"others",fields:["..."]}]);let b=Wn.Obj.evalFields(f,u,t=>w[t.uniqKey]?t:t.quickName&&_.isUndefined(t.value)?void 0:t),x=e||Wn.Util.getObjIcon(f,"zmdi-info-outline"),k=i||Wn.Util.getObjDisplayName(f),v=await Ti.App.Open({type:n,width:c,height:m,spacing:d,position:l,closer:a,escape:s,icon:x,title:k,actions:[{text:o,handler:({$main:t})=>_.cloneDeep({updates:t.updates,data:t.meta})},{text:r,handler:({$main:t})=>{let e=_.keys(t.updates);for(let i of e)if(T[i])return _.cloneDeep({updates:t.updates,data:t.meta})}}],ready(){this.$main.meta=f},comType:"modal-inner-body",components:[{name:"modal-inner-body",globally:!1,data:{myFormFields:b,currentTab:p,meta:void 0,updates:{}},template:'<ti-form\n          mode="tab"\n          :current-tab="currentTab"\n          :fields="myFormFields"\n          :data="meta"\n          @field:change="onFieldChange"\n          @change="onChange"\n          />',methods:{onChange(t){this.meta=t},onFieldChange({name:t,value:e}={}){let i=Ti.Types.toObjByPair({name:t,value:e});this.updates=_.assign({},this.updates,i)}}},"@com:ti/form","@com:ti/input/text","@com:wn/imgfile","@com:wn/obj/mode"]});if(!v)return;let{updates:O}=v,S=!1;if(y&&!_.isEmpty(O)){let t=JSON.stringify(O),e=`obj 'id:${f.id}' -ocqn -u`,i=await Wn.Sys.exec2(e,{input:t,as:"json"});return await Ti.Toast.Open("i18n:save-done","success"),S=!0,{updates:O,data:i,saved:S}}return v}}(),EditObjContent=function(){return async function(t="~",{title:e,icon:i,type:n="info",closer:a=!0,textOk:s,textCancel:o="i18n:cancel",position:r="top",width:l="80%",height:c="96%",spacing:m,readonly:d=!1,showEditorTitle:p=!0,content:u,placeholder:h="i18n:blank",autoSave:g}={}){let y=t;_.isString(y)&&(y=await Wn.Io.loadMeta(t)),_.isUndefined(s)&&(s=this.saveBy?"i18n:save":"i18n:ok"),g=Ti.Util.fallback(g,Ti.Util.isNil(u));let f=i||Wn.Util.getObjIcon(y,"zmdi-receipt"),w=e||"i18n:edit",T=g?await Wn.Io.loadContent(y):u,b=await Ti.App.Open({type:n,width:l,height:c,spacing:m,position:r,closer:a,title:w,result:T,comType:"ti-text-raw",comConf:{readonly:d,placeholder:h,icon:f,title:Wn.Util.getObjDisplayName(y),content:T,showTitle:p,ignoreKeyUp:!0},components:["@com:ti/text/raw"]});return g&&!_.isUndefined(b)&&b!=T&&(await Wn.Io.saveContentAsText(y,b),await Ti.Toast.Open("i18n:save-done","success")),b}}(),EditObjPrivilege=function(){return async function(t="~",{icon:e="fas-user-lock",title:i="i18n:wn-key-pvg",type:n="info",closer:a=!0,escape:s=!0,position:o="top",width:r=640,height:l="95%",autoSave:c=!0}={}){let m=t;_.isString(m)&&(m=await Wn.Io.loadMeta(t));let d=Ti.I18n.text(i)+" : "+(m.title||m.nm),p=await Ti.App.Open({type:n,width:r,height:l,position:o,closer:a,escape:s,icon:e,title:d,result:m.pvg,comType:"WnObjPrivilege",components:["@com:wn/obj/privilege"]});if(p&&!_.isEqual(m.pvg,p)){if(c){let t=_.isEmpty(p)?{"!pvg":!0}:{pvg:p},e=JSON.stringify(t),i=`o 'id:${m.id}' @update @json -cqn`,n=await Wn.Sys.exec2(i,{input:e,as:"json"});return await Ti.Toast.Open("i18n:save-done","success"),n}return m.pvg=p,m}}}(),EditTiComponent=function(){return async function({comType:t,comConf:e}={},{icon:i="fas-pencil-ruler",title:n="i18n:edit-com",type:a="info",closer:s=!0,textOk:o="i18n:ok",textCancel:r="i18n:cancel",position:l="top",width:c=800,height:m="90%",spacing:d}={}){return await Ti.App.Open({type:a,width:c,height:m,spacing:d,position:l,closer:s,icon:i,title:n,textOk:o,textCancel:r,comType:"hmaker-edit-com",comConf:{value:{comType:t,comConf:e}},result:{comType:t,comConf:_.cloneDeep(e)},components:["@com:hmaker/edit-com"]})}}(),OpenCmdPanel=function(){return async function(t,{title:e="i18n:run",icon:i="fas-running",type:n="info",closer:a=!0,textCancel:s="i18n:close",position:o="top",width:r="80%",height:l="90%",spacing:c,vars:m,input:d,forceFlushBuffer:p,showRunTip:u,cmdTipText:h,cmdTipIcon:g,onBodyReady:y,beforeClosed:f}={}){await Ti.App.Open({type:n,width:r,height:l,spacing:c,position:o,closer:a,icon:i,title:e,textCancel:s,textOk:null,model:null,ready:t=>{_.isFunction(y)&&y(t)},beforeClosed:f,comType:"WnCmdPanel",comConf:{value:t,tipText:h,tipIcon:g,vars:m,input:d,forceFlushBuffer:p,showRunTip:u},components:["@com:wn/cmd/panel"]})}}(),Youtube=function(){const t={async getVideoDetails(t,e=[]){if(!t||_.isEmpty(e))return;let{domain:i,thumbType:n}=t,a=`xapi req youtube ${i} videos -url -vars '${JSON.stringify({id:e.join(","),part:t.videoPart})}'`,s=await Wn.Sys.exec2(a,{as:"text"});if(!s)throw"Fail to get youtube API(videos) URL: "+a;let o=await Ti.Http.get(s,{as:"json"});if(!o||!_.isArray(o.items))throw"Fail to load youtube playlists by: "+a;let r=[];return _.forEach(o.items,t=>{let{id:e,snippet:i,contentDetails:a}=t,s={id:e,title:i.title,publishedAt:i.publishedAt,description:i.description,thumbUrl:_.get(i,`thumbnails.${n}.url`),defaultLanguage:i.defaultLanguage,defaultAudioLanguage:i.defaultAudioLanguage,categoryId:i.categoryId,duration:a.duration,definition:a.definition},o=Ti.DateTime.parseTime(s.duration);s.du_in_sec=o.value,s.du_in_str=o.toString("min"),r.push(s)}),r},async getAllVideos(e,i){if(!e)return;let n=await t.getPlaylistVideos(e,i),a=n.list||[];for(;n.next;)n=await t.getPlaylistVideos(e,i,{pageToken:n.next}),a=_.concat(a,n.list);return a},async getPlaylistVideos(e,i,{pageToken:n,maxResults:a=50}={}){if(!e)return;let{domain:s}=e;i=i||e.uploadsPlaylistId;let o=`xapi req youtube ${s} playlistItems -url -vars '${JSON.stringify({playlistId:i,part:"contentDetails",pageToken:n,maxResults:a})}'`,r=await Wn.Sys.exec2(o,{as:"text"});if(!r)throw"Fail to get youtube API(playlistItems) URL: "+o;let l=await Ti.Http.get(r,{as:"json"});if(!l||!_.isArray(l.items))throw"Fail to load youtube playlistItems by: "+o;let c=[];_.forEach(l.items,t=>{let e=_.get(t.contentDetails,"videoId");c.push(e)});return{list:await t.getVideoDetails(e,c),prev:l.prevPageToken,next:l.nextPageToken}},async getAllPlaylists(e,{force:i=!1}={}){if(!e)return;let{domain:n}=e,a=`~/.domain/youtube/${n}`,s=await Wn.Io.loadMeta(`${a}/playlists.json`),o=!0,r=[];if(s&&(r=await Wn.Io.loadContent(s,{as:"json"}),o=!1),o||i){let i=await t.getPlaylists(e);for(r=i.list||[];i.next;)i=await t.getPlaylists(e,{pageToken:i.next}),r=_.concat(r,i.list);let n=JSON.stringify(r);await Wn.Sys.exec2(`json -qn > ${a}/playlists.json`,{input:n})}return r},async getPlaylists(t,{pageToken:e,maxResults:i=50}={}){if(!t)return;let{domain:n,channelId:a,thumbType:s}=t,o=`~/.domain/youtube/${n}`,r=JSON.stringify({channelId:a,part:t.playlistPart,pageToken:e,maxResults:i}),l=`xapi req youtube ${n} playlists -url -vars '${r}'`,c=await Wn.Sys.exec2(l,{as:"text"});if(!c)throw"Fail to get youtube API(playlist) URL: "+l;let m=await Ti.Http.get(c,{as:"json"});if(!m||!_.isArray(m.items))throw"Fail to load youtube playlists by: "+l;r=JSON.stringify(m);let d=e?`_${e}.json`:".json";await Wn.Sys.exec2(`json -qn > ${o}/results/playlists${d}`,{input:r});let p=[];return _.forEach(m.items,t=>{let{id:e,snippet:i,contentDetails:n}=t,a={id:e,title:i.title,description:i.description,thumbUrl:_.get(i,`thumbnails.${s}.url`),itemCount:n.itemCount};p.push(a)}),{list:p,prev:m.prevPageToken,next:m.nextPageToken}},async loadConfig({domain:t,channelId:e,force:i=!1}={}){t||(t=Wn.Session.getCurrentDomain());let n=`~/.domain/youtube/${t}`,a=await Wn.Io.loadMeta(`${n}/youtube.json`),s=!0,o={};if(a&&(o=await Wn.Io.loadContent(a,{as:"json"}),s=!1),_.defaults(o,{domain:t,thumbType:"high",maxResults:50,channelId:e,channelTitle:"No Title",channelPart:"snippet,contentDetails,statistics",uploadsPlaylistId:null,playlistPart:"snippet,contentDetails,status,id,player,localizations",videoPart:"snippet,contentDetails,status,id,player"}),s||i){let i=JSON.stringify({id:e,part:o.channelPart}),a=`xapi req youtube ${t} channels -url -vars '${i}'`,s=await Wn.Sys.exec2(a,{as:"text"});if(!s)throw"Fail to get youtube API(channels) URL: "+a;let r=await Ti.Http.get(s,{as:"json"});if(!r||!_.isArray(r.items)||_.isEmpty(r.items))throw"Fail to load youtube channels by: "+a;i=JSON.stringify(r),await Wn.Sys.exec2(`json -qn > ${n}/results/channels.json`,{input:i}),o.channelTitle=_.get(r,"items.0.snippet.title"),o.uploadsPlaylistId=_.get(r,"items.0.contentDetails.relatedPlaylists.uploads"),i=JSON.stringify(o),await Wn.Sys.exec2(`json -qn > ${n}/youtube.json`,{input:i})}return o}};return t}(),WALNUT_VERSION="1.2-20210416.155103",HOOKs={};export const Wn={Version:WALNUT_VERSION,Io:Io,Obj:Obj,Session:Session,Sys:Sys,Util:Util,Dict:Dict,Hm:Hm,OpenObjSelector:OpenObjSelector,EditObjMeta:EditObjMeta,EditObjContent:EditObjContent,EditObjPrivilege:EditObjPrivilege,EditTiComponent:EditTiComponent,OpenThingManager:OpenThingManager,OpenCmdPanel:OpenCmdPanel,Youtube:Youtube,addHook(t,e){Ti.Util.pushValue(HOOKs,t,e)},doHook(t,e){let i=HOOKs[t];if(_.isArray(i)&&i.length>0)for(let t of i)t(e)}};export default Wn;window&&(window.Wn=Wn);