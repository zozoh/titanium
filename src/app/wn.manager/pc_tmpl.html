<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <!--link rel="stylesheet" type="text/css"
        href="${rs}/core/css/font-md/css/material-design-iconic-font.css"-->
  <script src="${rs}/ti/deps/lodash.min.js"></script>
  <script src="${rs}/ti/deps/vue.js"></script>
  <script src="${rs}/ti/deps/vuex.js"></script>

  <link rel="stylesheet" href="${rs}/ti/deps/element-ui/index.css">
  <script src="${rs}/ti/deps/element-ui/index.js"></script>

  <link rel="stylesheet" href="${rs}/ti/theme/${theme}.css">
  <link rel="stylesheet" href="${rs}/ti/deps/md/iconfont/material-icons.css">
  <link rel="stylesheet" href="${rs}/ti/deps/zmdi/css/material-design-iconic-font.css">
  <link rel="stylesheet" href="${rs}/ti/deps/fontawesome/5.7.2-web/css/all.css">
  <link rel="stylesheet" href="${rs}/ti/deps/iconmonstr/css/iconmonstr-iconic-font.css">
  
  <!--link rel="stylesheet" href="${rs}/ti/deps/muse-ui/muse-ui.css">
  <script src="${rs}/ti/deps/muse-ui/muse-ui.js"></script-->
</head>
<body class="main-body">
<div id="app" class="app-loading">
  <i class="zmdi zmdi-settings zmdi-hc-spin"></i>
</div>
<script type="module">
import {Ti} from "${rs}/ti/core/ti.mjs"
//---------------------------------------
window._app = ${app};
//---------------------------------------
Ti.SetForDev(true)
Ti.SetLogLevel("warn")
Ti.SetLogLevel("warn", "TiLoad")
Ti.SetLogLevel("warn", "TiApp")
Ti.SetLogLevel("warn", "TiHttp")
Ti.SetLogLevel("warn", "TiShortcut")
Ti.SetLogLevel("warn", "Wn.Sys")
Ti.SetLogLevel("info", "app/wn.manager")
//---------------------------------------
Ti.Config.set({
  prefix : {
    "app"   : "/a/load/",
    "MyApp" : "/a/load/${appName}/",
    "theme" : "${rs}/ti/theme/",
    "lib"   : "${rs}/ti/lib/",
    "deps"  : "${rs}/ti/deps/",
    "mod"   : "${rs}/ti/mod/",
    "com"   : "${rs}/ti/com/",
    "i18n"  : "${rs}/ti/i18n/"
  },
  alias : {
    "^.+[.](css|js|mjs|json|txt|text)$"  : "$&",
    "^\./"          : "@MyApp:",
    "@lib:walnut"   : "@lib:walnut/walnut.mjs",
    "^@MyApp:?$"    : "@MyApp:_app.json",
    "^@theme:.+$"   : "$&.css",
    "^@app:[^\/]+$"   : "$&/_app.json",
    "\/?mod\/[^\/]+$" : "$&/_mod.json",
    "\/?com\/[^\/]+$" : "$&/_com.json",
    "^@mod:[^.]+$"    : "$&/_mod.json",
    "^@com:[^.]+$"    : "$&/_com.json",
    "^@i18n:(.+)$"    : "@i18n:zh-cn/$1.i18n.json"
  },
  lang : "zh-cn"
})
//---------------------------------------
Ti.Dom.watchAutoRootFontSize({
  callback:({$root, mode})=>{
    $root.setAttribute("as", mode)
  }
})
//---------------------------------------
Ti.Install()
Ti.Shortcut.startListening()
//---------------------------------------
async function main(){
  // setup the i18n
  Ti.I18n.put(await Ti.Load("@i18n:_ti"))
  // Load main app
  let app = await Ti.App("@MyApp")
  await app.init()

  // Save current app name
  Ti.SetAppName(app.name())

  // Load session and display
  app.commit("session/set", _app.session)
  app.mountTo("#app")
  Ti.Session({
    "id"       : _app.session.id,
    "name"     : _app.session.me,
    "group"    : _app.session.grp,
    "duration" : _app.session.du,
    "vars" : _app.session.envs
  })

  // Hook the session env change
  Wn.addHook("update_envs", (envs)=>{
    Ti.SessionVar(envs)
  })

  // main obj path
  let basePath = "~"
  if(_app.obj) {
    basePath = "id:" + _app.obj.id
  }
  await app.dispatch("meta/reload", basePath)
  
  // just for fun
  return app.get("obj")
}
//---------------------------------------
main().then(o=>{
  if(Ti.IsInfo("main")) {
    console.log("MainLoaded", o)
  }
}).catch(err=>{
  throw err
})

//---------------------------------------
</script>
</body>
</html>