<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <!--link rel="stylesheet" type="text/css"
        href="${rs}/core/css/font-md/css/material-design-iconic-font.css"-->
  <script src="${rs}/ti/deps/jquery.js"></script>
  <script src="${rs}/ti/deps/lodash.min.js"></script>
  <script src="${rs}/ti/deps/vue.js"></script>
  <script src="${rs}/ti/deps/vuex.js"></script>

  <!--link rel="stylesheet" href="${rs}/ti/deps/element-ui/index.css">
  <script src="${rs}/ti/deps/element-ui/index.js"></script-->

  <link rel="stylesheet" href="${rs}/ti/deps/md/iconfont/material-icons.css">
  <link rel="stylesheet" href="${rs}/ti/deps/zmdi/css/material-design-iconic-font.css">
  <link rel="stylesheet" href="${rs}/ti/deps/fontawesome/5.7.2-web/css/all.css">
  <link rel="stylesheet" href="${rs}/ti/deps/iconmonstr/css/iconmonstr-iconic-font.css">

  <!--===========Theme============-->
  <link rel="stylesheet" href="${theme}">


  <!--===========ExtAPIs==========-->
  ${extlibs?}
  
  <!--link rel="stylesheet" href="${rs}/ti/deps/muse-ui/muse-ui.css">
  <script src="${rs}/ti/deps/muse-ui/muse-ui.js"></script-->
</head>
<body class="main-body">
<div id="app" class="app-loading">
  <i class="zmdi zmdi-settings zmdi-hc-spin"></i>
</div>
<script type="module">
import {Ti} from "${rs}/ti/core/ti.mjs"
import {Wn} from "${rs}/ti/lib/walnut/walnut.mjs"
//---------------------------------------
window._app = ${app};
//---------------------------------------
Ti.SetForDev(true)
Ti.SetLogLevel("warn")
Ti.SetLogLevel("warn", "TiLoad")
Ti.SetLogLevel("warn", "TiApp")
Ti.SetLogLevel("warn", "TiHttp")
Ti.SetLogLevel("warn", "TiShortcut")
Ti.SetLogLevel("warn", "Wn.Sys")
Ti.SetLogLevel("info", "WnGui")
Ti.SetLogLevel("warn", "Wn.Dict")
//---------------------------------------
Ti.Install()
Ti.Shortcut.startListening()
Ti.Viewport.startListening()
//---------------------------------------
async function main(){
  // Load Config
  let tiConf = await Wn.Sys.exec("ti config -cqn", {
    appName : "wn.manager", as:"json"
  })
  // Add defaults
  _.defaultsDeep(tiConf, {
    prefix : {
      "app"   : "/a/load/",
      "MyApp" : "/a/load/${appName}/",
      "theme" : "${rs}/ti/theme/",
      "lib"   : "${rs}/ti/lib/",
      "deps"  : "${rs}/ti/deps/",
      "mod"   : "${rs}/ti/mod/",
      "com"   : "${rs}/ti/com/",
      "i18n"  : "${rs}/ti/i18n/"
    },
    alias : {
      "^\./"          : "@MyApp:",
      "^@MyApp:?$"    : "@MyApp:_app.json",
      "^@i18n:(.+)$"  : "@i18n:zh-cn/$1",
      "\/i18n\/"      : "\/i18n\/zh-cn/",
      "^(@[A-Za-z]+):i18n/(.+)$" : "$1:i18n/zh-cn/$2"
    },
    suffix : {
      "^@theme:"              : ".css",
      "^@app:"                : "/_app.json",
      "(^@mod:|[\/:]mod\/)"   : "/_mod.json",
      "(^@com:|[\/:]com\/)"   : "/_com.json",
      "(^@i18n:|[\/:]i18n\/)" : ".i18n.json"
    },
    lang : "zh-cn"
  })

  //console.log("tiConf", tiConf)

  // Update Config Setting
  Ti.Config.set(tiConf)

  // Load the com common mixins 
  let comMixins = await Ti.Load("@com:ti/support/com_mixins.mjs")
  Ti.Config.set({
    comDecorator : (com)=>{
      //console.log("++++++Decorator", com.name)
      Ti.Util.pushValue(com, "mixins", comMixins)
    }
  })

  // setup the i18n
  Ti.I18n.put(await Ti.Load(["@i18n:_ti", "@i18n:_wn"]))

  // exit i18n
  if(tiConf.i18n) {
    Ti.I18n.put(await Ti.Load(tiConf.i18n))
  }

  // Load extend css
  if(tiConf.css) {
    let exCssList = [].concat(tiConf.css)
    for(let css of exCssList) {
      let cssPath = _.template(css)({theme:"${theme}"})
      await Ti.Load(cssPath)
    }
  }

  // Load main app
  let appInfo = await Ti.Load("@MyApp")
  
  // Merge customized GUI setting in "data"
  _.assign(appInfo.data, tiConf.gui)

  // Append exetend components
  if(!_.isEmpty(tiConf.components)) {
    Ti.Util.pushUniqValue(appInfo, "components", tiConf.components)
  }
  // Join the ext-deps
  if(!_.isEmpty(tiConf.deps)) {
    Ti.Util.pushUniqValue(appInfo, "deps", tiConf.deps)
  }
  // Load the global util modules
  for(let key of _.keys(tiConf.global)) {
    let val = tiConf.global[key]
    let mod = await Ti.Load(val) 
    window[key] = mod
  }
  // Setup dictionaly
  Wn.Dict.setup(tiConf.dictionary)

  // console.log(appInfo)
  // Do init
  let app = Ti.App(appInfo)
  await app.init()

  // Save current app name
  Ti.SetAppName(app.name())

  //---------------------------------------
  Ti.Dom.watchAutoRootFontSize(app, "viewport/setMode")

  // Load session and display
  app.commit("session/set", _app.session)
  app.mountTo("#app")
  Ti.Session({
    "id"       : _app.session.id,
    "name"     : _app.session.unm,
    "group"    : _app.session.grp,
    "duration" : _app.session.du,
    "vars" : _app.session.envs
  })

  // Hook the session env changing
  Wn.addHook("update_envs", (envs)=>{
    Ti.SessionVar(envs)
  })

  // main obj path
  let basePath = "~"
  if(_app.obj) {
    basePath = "id:" + _app.obj.id
  }
  await app.dispatch("reload", basePath)
  
  // just for fun
  return app.get("obj")
}
//---------------------------------------
main().then(o=>{
  if(Ti.IsInfo("main")) {
    console.log("MainLoaded", o)
  }
}).catch(err=>{
  throw err
})

//---------------------------------------
</script>
</body>
</html>